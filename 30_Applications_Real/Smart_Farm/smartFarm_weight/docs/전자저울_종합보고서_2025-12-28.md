# 전자저울 프로젝트 종합 보고서 (리팩터링 / 방향성 / 상용화)

- 작성일: 2025-12-28
- 대상 폴더: `01_project/2_실생활따라하기/전자저울/`
- 관찰 기반 자료: `캘리브레이션.ino`, `전저자울_도전1/전자저울도전1_01.ino`, `8개트레이조건/메인코드_01.ino`, `8개트레이조건/참고코드_#1.ino`, `라이브러리분석/HX711byRob/함수목록.md`

---

## 1) 한 줄 요약
**현재는 “HX711 기반 무게 측정/보정”과 “8트레이 조합 계산(포장/선별)”이 서로 분리되어 있고, 제품화 관점(안정화·오류 처리·UI/UX·안전·검증)이 아직 부족하므로, 모듈화 + 상태머신 + 안정화 알고리즘 + 문서/검증 체계를 중심으로 리팩터링하면 빠르게 ‘작동하는 프로토타입 → 반복 가능한 시스템’으로 전환 가능**합니다.

---

## 2) 현재 상태 진단

### 2.1 구현 요소(이미 확보된 것)
- HX711( Rob Tillaart 라이브러리 ) 기반 측정/보정 코드 존재
  - 오프셋(tare) + 스케일(scale) 산출 플로우가 명확함
- “안정화된 무게”를 만들려는 시도
  - `전저자울_도전1/전자저울도전1_01.ino`에서 히스테리시스 기반 반올림/고정 로직 적용
- 8트레이(8개의 HX711) 측정 및 조합 탐색 프로토타입
  - `8개트레이조건/*`에서 배열로 저울 인스턴스 관리
  - 타겟 무게 범위(`TARGET_WEIGHT_MIN/MAX`)와 조합 개수(`NUMBER_OF_COMBINATION`)를 바탕으로 유효 조합 탐색

### 2.2 현재의 주요 기술 부채/리스크
- **측정 안정성(노이즈/드리프트/진동) 관리가 “프로그램 구조”와 “알고리즘” 측면에서 아직 임시적**
- **I/O 핀 안전성 문제 가능성**
  - `8개트레이조건`에서 `ledPins[i] = DOUT_SCK_PIN[i][0];`처럼 HX711 DOUT 핀을 LED 출력처럼 쓰는 구조가 보임
  - DOUT는 HX711 출력(아두이노 입장에서는 입력) 성격이 강하므로, 디지털 출력으로 직접 구동하는 방식은 전기적으로 위험/오동작 가능성이 큼
- **블로킹/루프 구조의 혼재**
  - `캘리브레이션.ino`는 시리얼 입력 대기(블로킹) 기반으로 “도구용 스케치”로는 OK지만, 제품/시스템 코드에 합쳐지면 멈춤/먹통 원인이 됨
- **코딩 가이드라인(공통 규칙)와 불일치**
  - 예: 매직넘버(핀/샘플 수/지연), 상수 네이밍, `loop()`가 “목차 역할”을 못하고 길어질 위험
- **컴파일/런타임 문제 가능성**
  - `전저자울_도전1/전자저울도전1_01.ino`에 `delay(DEALY_TIME);`(오타로 보임) 등
  - `isReadyHX711()` 같은 함수 호출이 보이는데 정의가 확인되지 않음(다른 파일/탭에 있을 수 있음)

---

## 3) 리팩터링 권장 항목 (우선순위 포함)

### 3.1 P0 — 안전/정확도에 직결되는 항목(먼저)
1) **핀/전기적 안전 정리**
   - HX711 DOUT/SCK 핀은 센서 통신용으로만 사용
   - LED 표시가 필요하면 별도 GPIO(또는 드라이버/확장 IO, NeoPixel 등)를 사용
   - 8채널이면 배선/접지/전원 설계(스타그라운드, 굵은 전원선, 센서선 실드)도 문서화

2) **측정 파이프라인 분리(읽기 → 필터링 → 안정판정 → 값 확정)**
   - 지금처럼 `get_units()` 즉시 사용 대신 다음 계층을 분리
     - Raw 읽기(ready 체크/timeout 포함)
     - 필터(median/medavg/runavg 중 택1 + 파라미터)
     - 안정화 판정(일정 시간동안 변화량이 임계 이하)
     - 확정값 publish(그램 정수화, 히스테리시스 적용)

3) **오류 처리/재시도 정책을 명시적으로**
   - HX711 준비 상태 체크: `wait_ready_retry`, `wait_ready_timeout` 활용
   - 센서 미연결/불량 시: 해당 트레이를 “비활성” 상태로 표시하고 조합 계산에서 제외

### 3.2 P1 — 구조/확장성을 만드는 항목
4) **상태 머신(FSM) 도입**
   - 요구사항(포도 송이 올리고 내리는 과정, 안정화 시간, 조합 계산 락 등)이 명확히 상태로 표현되는 문제
   - 추천 상태 예시
     - `BOOT`
     - `IDLE_EMPTY` (모든 트레이 0 근처)
     - `WAIT_STABLE` (진동/출렁임 수렴 대기)
     - `MEASURE` (안정값 스냅샷)
     - `FIND_COMBINATION`
     - `DISPLAY_SELECTION` (LED/시리얼 안내)
     - `LOCK_UNTIL_REMOVED` (선택된 트레이가 내려갈 때까지 다음 계산 금지)

5) **설정값(Config) 집중화**
   - 보드/핀맵/보정값/샘플 수/임계값/타겟범위/조합 개수 등을 한 곳에 모으기
   - 상수는 `UPPER_SNAKE_CASE` 사용(프로젝트 가이드라인 준수)

6) **시리얼 명령 기반 운영 UI 정립(프로젝트 표준화)**
   - 현재 `캘리브레이션.ino`는 “대화형 보정 도구”로 훌륭함
   - 이를 시스템에 합치려면 `CAL`, `TARE`, `GAIN 128`, `MODE MEDIAN`, `TARGET 2000 2100`, `COMBO 4` 같은 명령 세트를 정의하는 것이 좋음

### 3.3 P2 — 성능/품질 개선(후순위지만 가치 큼)
7) **조합 탐색 알고리즘 개선**
   - 현재 방식은 재귀 탐색 + 모든 유효 조합 저장(배열 크기 제한) 구조
   - 트레이 수가 늘거나 조건이 복잡해지면 비용이 커짐
   - 개선 방향(택1/복수)
     - “첫 번째 해(최초로 찾는 조합)만 필요”하면 조기 종료
     - “최적 조합(오차 최소, 특정 등급 우선)”이 필요하면 점수 기반 탐색
     - 중복 계산 방지(정렬 후 투포인터/meet-in-the-middle 등)도 가능

8) **기록/진단(로그) 체계**
   - 트레이별 raw/filtered/stable 값, 상태 전환, 센서 오류 등을 일정 주기로 출력
   - 필요 시 `DEBUG` 플래그로 on/off

---

## 4) 같은 워크스페이스 프로젝트들과 비교한 방향성

### 4.1 waterMotorControl(스마트팜)에서 배울 점
- 버튼 디바운스/주기 제어를 `millis()` 기반으로 분리한 점은 “전자저울의 안정화 시간/락 타이머”에도 그대로 적용 가능
- 전자저울도 “측정 주기(예: 50~200ms)”, “안정화 윈도(예: 1~2s)”, “조합 갱신 주기(예: 500ms)”처럼 타이머를 분리하면 루프가 훨씬 읽기 쉬워짐

### 4.2 도로공사 싸인보드에서 배울 점
- 입력(버튼) → 상태(모드) → 출력(LED 패턴) 흐름이 명확함
- 전자저울도 동일하게
  - 입력: 트레이 무게 변화, 시리얼 명령
  - 상태: FSM
  - 출력: 선택 트레이 표시, 경고 표시
  로 구조를 맞추면 유지보수가 쉬워짐

### 4.3 공기질 PMS7003 문서/명령 설계에서 배울 점
- 문서에 “목적/하드웨어 연결표/명령표/메모리 사용량/제한 사항”을 명시한 점이 강점
- 전자저울은 센서/배선/보정 절차가 더 민감하므로, 제품화 관점에서 이 수준의 문서가 사실상 필수

---

## 5) 상용화 가능성 평가(현실적인 관점)

### 5.1 상용화 가능 시나리오(2가지)
1) **“내부 공정 보조용(비거래/참고용)”**
   - 목표: 포장/선별을 빠르게 돕는 안내 시스템(조합 추천 + LED 안내)
   - 장점: 법정 계량(거래용 저울) 규제를 피하기 쉬움
   - 단점: 고객이 ‘정확한 계량값’을 요구하면 분쟁 소지가 있어 표시/고지 필요

2) **“거래용/공식 계량(판매 단위)”**
   - 목표: 측정값 자체가 거래/가격 산정에 직접 사용
   - 난이도/비용이 급상승(계량 관련 인증/검정/봉인, 장기 드리프트 보정, 환경시험 등)
   - 현재 코드/하드웨어 단계에서는 “먼 목표”로 보는 게 합리적

### 5.2 기술 리스크(제품 관점)
- 노이즈/진동/온도 변화에 따른 드리프트
- 8개 HX711 동시 운용 시 전원/접지/배선 영향(크로스톡, 측정 튐)
- 사용자가 포도 송이를 올리는 동작 자체가 큰 외란(안정화 로직이 핵심 경쟁력)
- 센서 불량/단선/커넥터 접촉불량 등 현실 장애

### 5.3 상용화에 필요한 추가 구성(최소 요건)
- 하드웨어
  - 안전한 LED 표시 회로(별도 핀 + 저항/드라이버)
  - 커넥터/케이블 고정, 전원 안정화(레귤레이터, 디커플링)
  - 케이스/방진(작업장 환경 고려)
- 소프트웨어
  - 영점 자동감지(장시간 사용 시)
  - 안정화 판정의 신뢰성(‘안정’의 정의와 수치화)
  - 셀프테스트(부팅 시 센서 ready 체크)
  - 설정 저장(EEPROM/Flash): 보정값/설정값 유지
- 운영/문서
  - 보정 절차서(추 표준 무게, 주기, 기록)
  - 사용자 매뉴얼(오류 메시지와 대처)

---

## 6) 추천 로드맵(실행 가능한 단계)

### 단계 A — “제대로 측정하기” (1~3일)
- 트레이 1개 기준으로
  - `tare`, `calibration_factor`, `gain`, `mode(median/medavg/runavg)`를 명령으로 변경 가능하게
  - 안정화 판정(시간 윈도 + 변화량 임계값) 구현
  - 보정값/설정값을 EEPROM에 저장

### 단계 B — “8트레이로 확장” (3~7일)
- 8트레이 읽기 루프를 “순차 읽기 + timeout”으로 고정
- 트레이별 상태(OK/NO_SENSOR/UNSTABLE/EMPTY) 도입
- LED 핀 분리(센서 핀과 물리적으로 분리)

### 단계 C — “조합 추천을 제품처럼” (1~2주)
- 조합 탐색을 ‘첫 해만 찾기’ 또는 ‘최적 해 찾기’로 명확히 정의
- `LOCK_UNTIL_REMOVED` 구현으로 사용성 향상
- 시리얼 UI를 표준화(HELP, STATUS, CAL, TARE, TARGET, COMBO, MODE 등)

---

## 7) 바로 적용 가능한 체크리스트
- [ ] HX711 DOUT 핀을 LED 출력으로 쓰지 않기
- [ ] `loop()`는 상태 갱신/로직/출력 3줄 수준으로 유지
- [ ] 상수/핀/시간/횟수 매직넘버 제거(상수화)
- [ ] `wait_ready_retry/timeout` 기반으로 센서 예외 처리
- [ ] 안정화 판정(시간 윈도 + 변화량) 추가
- [ ] 보정값(오프셋/스케일) 저장/불러오기(EEPROM)

---

## 부록 A) 추천 문서 구성(전자저울 폴더에 추가하면 좋은 것)
- `docs/README.md`: 프로젝트 목적/구성/배선도/핀맵
- `docs/calibration.md`: 표준 추로 보정하는 절차, 오차 확인 방법
- `docs/serial_commands.md`: 명령 목록/예시/에러 코드
- `docs/test_plan.md`: 재현 가능한 테스트 시나리오(진동, 시간 경과, 트레이 교체 등)
