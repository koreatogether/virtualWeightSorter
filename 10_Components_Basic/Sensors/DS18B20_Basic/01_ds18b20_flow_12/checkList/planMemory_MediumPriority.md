# 메모리 안정성 중단기(단기) 목표 실행 계획서

## 📅 작성일: 2025-07-28
## 📌 적용 대상: Arduino UNO R4 WiFi (Renesas RA4M1, 32KB SRAM, 256KB Flash)

---

## ⚠️ 단기 적용 (Medium Priority) 목표

1. 🔄 메모리 사용량 모니터링 - 런타임 추적 (기본형 완료)
2. 📋 스택 깊이 제한 - 재귀/호출 스택 관리
3. 📋 String 객체 관리 - 라이프사이클 최적화
4. 📋 에러 복구 메커니즘 - 안정적 시스템 운영

---

## 1. 메모리 사용량 모니터링 (런타임 추적)

### 목표
- 실시간으로 RAM 사용량을 추적하여 임계 상황을 감지하고, 로그 및 경고를 남긴다.
- **보드 특성**: Renesas RA4M1은 32KB SRAM, 256KB Flash로 AVR과 달리 heap/stack 경계가 넓고, 메모리 부족 임계점이 2KB/1KB보다 높음. 실제 임계값은 4KB/2KB로 설정 권장.

### 세부 실행 계획
- [x] MemoryUsageTester의 freeMemory() 활용 (Renesas 환경에 맞게 구현)  ( 완료: 일부 적용)
- [x] 임계값(4KB/2KB) 경고 및 중단 로직 구현 ( 완료: 일부 적용)
- [ ] 주요 함수 진입/종료 시 메모리 상태 기록 , 우선 구현시킴 , 컴파일 이상없음 , 
- [ ] 메모리 사용량 변화 패턴 분석 및 리포트 자동 생성
- [ ] 장기 동작 시 누적 메모리 변화 기록

---

## 2. 스택 깊이 제한 (재귀/호출 스택 관리)

### 목표
- 재귀 및 깊은 함수 호출로 인한 스택 오버플로우 방지
- **보드 특성**: Renesas RA4M1은 스택 크기가 AVR보다 크지만, 대용량 배열/재귀 사용 시 여전히 위험. 스택 사용량 추적은 직접 측정이 어려우므로, 호출 깊이 제한과 대형 지역 변수 사용 금지 중심으로 관리.

### 세부 실행 계획
- [ ] 재귀 함수 호출 시 depth 변수 도입 및 최대 깊이 제한 (예: 10~20)
- [ ] 주요 함수에 호출 깊이 체크 코드 삽입
- [ ] 대형 지역 변수는 static/global로 이동
- [ ] 스택 오버플로우 감지 시 안전한 종료 및 경고

---

## 3. String 객체 관리 (라이프사이클 최적화)

### 목표
- String 객체의 생성/소멸, 메모리 할당/해제 패턴을 최적화하여 누수 및 불필요한 할당 방지
- **보드 특성**: Renesas 환경에서는 String 객체가 heap을 사용하므로, 대량 생성/삭제 시 heap 단편화 및 누수 위험. String 대신 char[] 사용 권장.

### 세부 실행 계획
- [ ] String 객체 사용 위치 전수 조사
- [ ] 불필요한 임시 String 객체 제거
- [ ] String → char[] 변환 가능성 검토 및 적용
- [ ] String 객체 소멸 시점 명확화 및 메모리 회수 확인
- [ ] String 관련 메모리 사용량 프로파일링 (heap fragmentation 포함)

---

## 4. 에러 복구 메커니즘 (안정적 시스템 운영)

### 목표
- 메모리 부족, 스택 오버플로우 등 임계 상황 발생 시 시스템이 안전하게 복구 또는 graceful degradation
- **보드 특성**: Renesas RA4M1은 하드웨어 리셋이 빠르며, 소프트웨어적으로 비필수 기능 비활성화/리셋 루틴 구현이 용이함.

### 세부 실행 계획
- [ ] 메모리 부족 시 비필수 기능 자동 비활성화 (센서/통신/로그 등 단계적 비활성화)
- [ ] 에러 발생 시 안전한 리셋/복구 루틴 구현 (watchdog 활용 가능)
- [ ] 에러 로그 및 상태 기록 시스템 강화 (Flash/Eeprom 기록)
- [ ] 복구 후 정상 동작 여부 자동 테스트
- [ ] 에러 복구 시 사용자 알림 및 로그 남기기

---

## 일정 및 우선순위

| 단계 | 목표                          | 예상 기간 | 우선순위 |
| ---- | ----------------------------- | --------- | -------- |
| 1    | 메모리 사용량 모니터링 고도화 | 1주       | 상       |
| 2    | 스택 깊이 제한 및 감지        | 2주       | 상       |
| 3    | String 객체 관리 최적화       | 2주       | 중       |
| 4    | 에러 복구 메커니즘 구현       | 2~3주     | 상       |

---

## 성공 지표
- 임계 상황 발생 시 시스템 크래시 없이 정상 복구
- 메모리/스택 오버플로우 사전 감지 및 경고
- String 객체 관련 메모리 누수 0건
- 에러 발생 시 자동 복구 성공률 95% 이상
- 모든 주요 상황에 대한 로그 및 리포트 자동 생성

---

## 참고
- memory_optimization_checklist.md의 Medium Priority 항목과 연동
- changelog 및 memory_safety_completion_report.md에 진행 상황 기록
- Renesas UNO R4 WiFi 보드 특성(32KB SRAM, 256KB Flash, heap/stack 구조) 반영

---

**담당자:** (작성자 이름 기입)
**다음 검토일:** 2025-08-04
