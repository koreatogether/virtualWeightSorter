#ifndef MEMORY_USAGE_TESTER_H
#define MEMORY_USAGE_TESTER_H

#include "exclude_memory_analysis.h" // 항상 가장 먼저 포함

// 메모리 분석 기능이 비활성화되어 있으면 아무것도 하지 않는 빈 클래스 정의
#if defined(MEMORY_ANALYSIS_ENABLED) && MEMORY_ANALYSIS_ENABLED == 0

// 비활성화된 메모리 테스터 (빈 구현)
class MemoryUsageTester
{
public:
    inline int freeMemory() { return 0; }
    inline void runBasicTest() {}
    inline void runStressTest(int = 0) {}
    inline void printMemoryStatus(const char *) {}
    inline void testDataStructures() {}
    inline void printMemoryStatusCSV(const char *, const char *) {}
    inline void logMemoryUsage() {}
};

#else

// 원래 구현은 MEMORY_ANALYSIS_ENABLED가 1일 때만 활성화
#ifdef UNIT_TEST
#include "FakeArduino.h"
#else
#include <Arduino.h>
#endif

// AVR에서만 사용
#if defined(ARDUINO_ARCH_AVR)
extern unsigned int __heap_start;
extern void *__brkval;
#endif

/**
 * @brief Memory usage measurement and testing class
 * @details Provides functionality to measure RAM usage during different operations
 * for debugging and optimization purposes on Arduino ATmega328P boards
 */
class MemoryUsageTester
{
public:
    int freeMemory();
    void runBasicTest();
    void runStressTest(int iterations = 10);
    void printMemoryStatus(const char *label);
    void testDataStructures();

    // PC 분석용 CSV 로그 출력
    void printMemoryStatusCSV(const char *function, const char *event);

    // 메모리 상태 로깅 (센서 오류 시에도 지속)
    void logMemoryUsage();

private:
    void testDynamicAllocation();
    void testStaticArrays();
    void testObjectCreation();
};

#endif // MEMORY_ANALYSIS_ENABLED

#endif // MEMORY_USAGE_TESTER_H
