# 문제 해결 및 코드 개선 계획

분석된 내용을 바탕으로, 시스템의 안정성과 사용자 경험을 개선하기 위한 계획을 우선순위별로 수립합니다.

## 우선순위 정의
- **P0 (최우선):** 시스템의 핵심 기능 안정성에 직접적인 영향을 주는 시급한 버그.
- **P1 (높음):** 사용자 경험에 큰 영향을 미치는 기능 오류 또는 비효율.
- **P2 (중간):** 코드 품질, 유지보수성, 성능을 개선하기 위한 리팩토링.

---

문제 해결에 앞서
우선 고려 해야 하는 것  
현재 컴파일 후 스케치 메모리 사용량은 27% 전후 인데 
아래의 계획을 수정하닥 컴파일이 40%를 넘어가면 경고하고 
멈추도록 해야 한다.


## P0: 상태 불일치 문제 해결 및 데이터 동기화 (가장 시급)

**문제:** ID 변경(EEPROM 쓰기) 직후, 변경된 상태가 시스템에 즉시 반영되지 않아 후속 작업이 실패합니다. 이는 가장 먼저 해결해야 할 핵심적인 안정성 문제입니다.

**해결 방안:**
1.  **상태 갱신 함수 호출:** ID를 변경하는 로직(예: `changeId` 함수)이 성공적으로 완료된 직후, 센서 상태를 즉시 다시 스캔하고 내부 데이터를 갱신하는 로직을 **반드시** 호출해야 합니다.
2.  **중앙화된 데이터 갱신:** 아래 P2에서 제안된 `_refreshSensorData()`와 같은 중앙화된 스캔 함수를 구현하고, EEPROM에 쓰는 작업이 끝난 직후 이 함수를 호출하여 시스템 전체의 상태를 동기화합니다.
3.  **피드백 제공:** 상태 갱신이 완료된 후, 사용자에게 변경된 최종 결과를 명확히 보여주어 작업이 성공적으로 반영되었음을 알립니다.

**기대 효과:**
- ID 변경 후 발생하던 치명적인 상태 불일치 버그 해결.
- 시스템의 예측 가능성 및 안정성 대폭 향상.

---

## P1: 사용자 입력 파싱 및 메뉴 로직 오류 수정

**문제:** 특정 형식의 사용자 입력(`78`)을 처리하지 못하고, 메뉴 타임아웃이 동작하지 않으며, 불필요한 메뉴가 표시되는 등 사용자 경험을 저해하는 버그가 다수 존재합니다.

**해결 방안:**
1.  **입력 파싱 로직 강화:**
    -   쉼표(`,`)나 공백 없이 연속된 숫자(예: `78`)로 입력된 경우에도 이를 유효한 두 개의 숫자로 인식할 수 있도록 파싱 로직을 수정합니다.
    -   입력값에 대한 예외 처리(예: 숫자가 아닌 문자, 범위를 벗어나는 숫자)를 강화하여 안정성을 높입니다.
2.  **메뉴 로직 수정:**
    -   **타임아웃:** `millis()`를 사용한 타임아웃 로직이 루프 내에서 올바르게 동작하는지 검토하고 수정합니다. 루프가 지연(delay)에 의해 차단되지 않는지 확인합니다.
    -   **조건부 메뉴 표시:** '개별 ID 변경'과 같은 메뉴를 표시하기 전에, 변경할 수 있는 ID를 가진 센서가 실제로 존재하는지 먼저 확인하는 조건을 추가합니다. (이 작업은 P2 리팩토링이 선행되면 더 쉬워집니다.)

**기대 효과:**
- 사용자가 다양한 형식으로 입력해도 시스템이 안정적으로 동작.
- 더 직관적이고 오류 없는 메뉴 흐름 제공.

---

## P2: 센서 데이터 스캔 로직 중앙화 리팩토링

**문제:** 여러 함수가 개별적으로 센서 버스를 스캔하여 동일한 작업을 반복하고 있어 비효율적이며, 상태 관리(예: `_hasInvalidSensors`)를 복잡하게 만듭니다.

**해결 방안:**
1.  **중앙 데이터 구조체 생성:** 모든 센서의 상태 정보(주소, ID, 온도, 유효성 등)를 담을 수 있는 구조체 배열을 `DataProcessor` 클래스 내에 선언합니다.
2.  **Private 헬퍼 함수 구현 (`_refreshSensorData()`):**
    -   이 함수는 호출 시 모든 센서 버스를 **단 한 번만** 스캔합니다.
    -   스캔한 정보(주소, ID 등)를 1번에서 만든 중앙 데이터 구조체에 모두 저장합니다.
    -   `_hasInvalidSensors`와 같은 클래스 전체에서 사용되는 상태 변수들을 이 함수 내에서 한 번에 갱신합니다.
3.  **기존 함수 리팩토링:**
    -   `printSensorTable`, `printInvalidSensorTable`, `hasInvalidSensors`, `printAvailableIds` 등 기존에 버스를 스캔하던 모든 함수들을 수정합니다.
    -   이제 이 함수들은 직접 버스를 스캔하는 대신, `_refreshSensorData()` 호출 후 잘 정리된 중앙 데이터 구조체를 읽어와 정보를 출력하거나 상태를 반환하도록 변경합니다.

**기대 효과:**
-   **성능 향상:** 불필요한 I2C/1-Wire 통신을 제거하여 전체적인 응답 속도 개선.
-   **코드 중복 감소:** 유지보수가 용이해지고 코드베이스가 깔끔해짐.
-   **상태 관리 용이성:** P0 문제의 근본적인 해결을 돕고, 향후 새로운 기능을 추가할 때 발생할 수 있는 상태 관련 버그를 예방.
