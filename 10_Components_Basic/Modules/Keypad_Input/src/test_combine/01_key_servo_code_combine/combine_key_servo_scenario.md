# test_50_scenario.ino - 키패드 잠금장치 통합 테스트

## 개요
4x4 키패드와 서보모터를 사용한 디지털 잠금장치의 통합 테스트 시나리오입니다. 비밀번호 입력, 서보모터 제어, 보안 시스템, 수동 해제 기능을 모두 포함한 완전한 시스템 테스트 코드입니다.

## 하드웨어 구성

### 핀 연결
- **키패드**: 행(9,8,7,6) / 열(5,4,3,2)
- **서보모터**: 핀 10
- **수동 해제 버튼**: 핀 11 (INPUT_PULLUP)
- **부저**: 핀 12

### 주요 컴포넌트
- 4x4 매트릭스 키패드 (Adafruit_Keypad 라이브러리)
- 서보모터 (0도=잠금, 180도=해제)
- 수동 해제 버튼 (비상용)
- 경고 부저

## 시스템 상태

### SystemMode 열거형
```cpp
enum SystemMode {
    IDLE,             // 대기 모드 - 키패드 입력 대기
    SECURITY_LOCKDOWN // 보안 잠금 모드 - 5회 실패 후 활성화
}
```

## 비밀번호 시스템

### 입력 형식
- **정확한 형식**: `*123456#` 또는 `*123456*`
- **기본 비밀번호**: "123456"
- **입력 타임아웃**: 10초

### 올바른 비밀번호 입력 프로세스
1. `*` 키로 비밀번호 입력 시작
2. 6자리 숫자 입력 (각 입력시 `*` 출력으로 마스킹)
3. `#` 또는 `*`로 입력 완료
4. 비밀번호 검증 (`processPasswordInput()`)
5. 성공시:
   - `failureCount` 초기화
   - `unlockDoor()` 호출 → 서보모터 180도 회전
   - 5초 후 자동 재잠금 (`handleAutoLock()`)

## 보안 시스템

### 실패 처리
- **최대 허용 실패**: 5회 (`MAX_FAILURES`)
- **실패시**: `failureCount` 증가, IDLE 상태 유지

### 보안 잠금 (5회 실패 후)
1. **활성화** (`activateSecurityLockdown()`):
   - `SECURITY_LOCKDOWN` 모드 전환
   - 서보모터 강제 잠금 위치(0도) 고정
   - 부저 활성화
   - 타이머 시작 (부저용/잠금용 동시)

2. **잠금 기간**: 총 2분 (120초)
   - **0~60초**: 1초 간격 부저 경고음 + 잠금 상태
   - **60~120초**: 부저 정지 + 잠금 상태 유지
   - **120초 후**: 정상 작동 복귀

3. **해제**: `handleLockdownMode()`에서 시간 만료시
   - `IDLE` 모드 복귀
   - `failureCount` 초기화
   - 부저 완전 정지

## 수동 해제 시스템

### 수동 해제 버튼 (핀 11)
- **정상 작동시**: 즉시 잠금 해제 가능
- **보안 잠금시**: 수동 해제 비활성화
- **디바운스**: 200ms 간격으로 중복 입력 방지

## 타이밍 제어

### 주요 시간 상수
```cpp
const unsigned long BUZZER_DURATION = 60000;    // 1분 - 부저 동작 시간
const unsigned long LOCKDOWN_DURATION = 120000; // 2분 - 보안 잠금 지속 시간
const unsigned long UNLOCK_DURATION = 5000;     // 5초 - 해제 상태 유지 시간
const unsigned long BUZZER_INTERVAL = 1000;     // 1초 - 부저 on/off 간격
const unsigned long PASSWORD_ENTRY_TIMEOUT = 10000; // 10초 - 비밀번호 입력 타임아웃
const unsigned long DEBOUNCE_DELAY = 200;       // 200ms - 키패드 디바운스
```

### 자동 잠금
- 해제 후 5초 뒤 자동으로 재잠금
- `handleAutoLock()`에서 `servoUnlockTime` 기준으로 처리

## 입력 검증 및 보안

### 키패드 디바운스
- 마지막 키 입력으로부터 200ms 이내 입력 무시
- `lastKeyPressTime` 변수로 추적

### 입력 패턴 검증
- `*`로 시작하지 않으면 입력 무시
- 6자리 숫자만 허용
- 올바른 종료 문자(`#` 또는 `*`) 필수
- 잘못된 패턴시 버퍼 초기화

### 타임아웃 처리
- 10초 내 입력 완료하지 않으면 자동 초기화
- 6자리 완성 후 타임아웃시 틀린 비밀번호로 처리

## 시리얼 출력 메시지

### 시작 메시지
```
키패드 서보모터 통합 잠금장치 시작
비밀번호 형식: *123456# 또는 *123456*
수동 해제 버튼 사용 가능
```

### 상태 메시지
- `"비밀번호 입력 시작"` - `*` 키 입력시
- `"Correct password entered"` - 올바른 비밀번호
- `"Wrong password"` - 틀린 비밀번호
- `"잠금 해제"` / `"자동 잠금"` - 서보 상태 변경
- `"수동 해제"` - 버튼으로 해제
- `"Maximum attempts exceeded - security lockdown activated"` - 보안 잠금
- `"보안 잠금 해제 - 정상 작동 복귀"` - 잠금 해제

## 주요 함수 설명

### 메인 루프 함수들
- `handleIdleMode()`: 키패드 입력 처리 및 비밀번호 검증
- `handleLockdownMode()`: 보안 잠금 상태 관리 및 해제 타이밍
- `handleAutoLock()`: 자동 재잠금 처리
- `handleBuzzer()`: 보안 잠금시 부저 제어

### 핵심 기능 함수들
- `processPasswordInput()`: 입력된 비밀번호 검증 및 처리
- `unlockDoor()`: 서보모터 해제 및 타이머 설정
- `handleManualUnlock()`: 수동 해제 처리 (보안 잠금시 차단)
- `activateSecurityLockdown()`: 보안 잠금 활성화

## 테스트 시나리오

### 정상 작동 테스트
1. `*123456#` 입력 → 잠금 해제 → 5초 후 재잠금
2. 수동 버튼 → 즉시 해제 → 5초 후 재잠금

### 보안 기능 테스트
1. 잘못된 비밀번호 5회 입력
2. 보안 잠금 활성화 확인
3. 1분간 부저 작동 확인
4. 2분 후 정상 복귀 확인
5. 보안 잠금 중 수동 해제 차단 확인

### 예외 처리 테스트
- 잘못된 입력 형식 (`*12345#`, `123456#`, `*1234567#`)
- 입력 타임아웃 (10초 초과)
- 키패드 디바운스 (빠른 연속 입력)