# 키패드 잠금 장치 시나리오

## 개요
이 시나리오는 Arduino 기반 키패드 잠금 장치의 작동 흐름을 설명합니다. 사용자가 키패드를 통해 비밀번호를 입력하여 장치를 잠금 해제하는 과정을 다룹니다.

## 주요 구성 요소
- **키패드**: 4x4 매트릭스 키패드 (Adafruit_Keypad 라이브러리)
  - 핀 연결: rowPins[9,8,7,6], colPins[5,4,3,2]
  - 디바운스 처리: 200ms
- **시스템 모드**: IDLE, SECURITY_LOCKDOWN
- **비밀번호**: 기본값 "123456" (correctPassword 변수)
- **부저**: 12번 핀, 보안 잠금 시 경고음

## 시나리오 흐름

### 1. 초기 상태 (IDLE 모드)
- 시스템이 대기 상태 (currentMode = IDLE)
- handleIdleMode() 함수에서 키패드 입력 처리
- 실패 카운터 초기화 상태

### 2. 비밀번호 입력 시작
- 사용자가 '*' 키를 눌러 입력 시작
- inputBuffer = "*", passwordEntryStartTime 기록
- 입력 형식: `*XXXXXX#` 또는 `*XXXXXX*`
- **입력 타임아웃**: 10초 (PASSWORD_ENTRY_TIMEOUT)

### 3. 입력 검증 및 처리
- **디바운스 처리**: 200ms 이내 중복 입력 무시
- **숫자 입력**: 0-9만 허용, 최대 6자리
- **종료 문자**: '#' 또는 '*' (6자리 입력 후)
- **타임아웃 처리**: 10초 초과 시 버퍼 초기화 또는 강제 처리

### 4. 비밀번호 확인 (processPasswordInput 함수)
- **형식 검증**: 길이 8, 시작 '*', 종료 '#'/'*'
- **비밀번호 추출**: substring(1, 7)로 6자리 추출
- **올바른 비밀번호**: unlockDoor() 호출, failureCount = 0
- **틀린 비밀번호**: failureCount 증가

### 5. 보안 잠금 처리
- **5회 실패 시**: activateSecurityLockdown() 호출
- **SECURITY_LOCKDOWN 모드**: 2분간 입력 불가
- **부저 경고**: 1분간 1초 간격 on/off
- **수동 해제 비활성화**: 보안 잠금 중 물리적 버튼 무효

### 6. 오류 처리
- 잘못된 입력 형식: "Invalid input format"
- 틀린 비밀번호: "Wrong password"
- 6자리 후 잘못된 종료키: 강제 '#' 추가 후 처리
- 입력 타임아웃: 6자리 완료 시 자동 처리, 미완료 시 초기화

### 성공적인 잠금 해제
1. 사용자가 `*123456#` 입력
2. 시스템이 비밀번호 확인
3. "Correct password entered" 메시지 출력
4. 잠금 해제 동작 수행

### 실패 케이스
1. 사용자가 `*123456` 입력 (종료 구분자 없음)
2. "Invalid input format" 메시지 출력
3. 시스템 대기 상태 유지

#### 비밀번호 실패 및 대기 시간 예시

1. **연속 실패 진행**:
   - **5번째 실패: 1분 부저 경고음 + 2분 입력 불가**
     - 부저가 1분간 일정 간격으로 울림 (예: 1초 울림, 1초 정지)
     - 1분 부저 경고음 동시에 2분간 키패드 입력이 불가능
     - 경고 메시지 출력: "Maximum attempts exceeded - security lockdown activated"

2. **대기 시간 종료 후**:
   - 시스템이 IDLE 모드로 복귀
   - 사용자가 다시 입력 가능

## 기술적 세부 사항
- 입력 완료 시 버퍼가 초기화되어 다음 입력 준비
- 비밀번호 실패 시 대기 시간은 millis() 함수를 사용하여 구현
- 실패 횟수는 내부 카운터로 추적되며, 성공 시 초기화
- 대기 시간 동안 시스템은 입력을 완전히 무시
- 5번째 실패 시 부저를 1분간 일정 간격으로 울림 (예: 1초 울림, 1초 정지 반복)
- 1분 부저 경고음 동시에 2분간 키패드 입력이 불가능
