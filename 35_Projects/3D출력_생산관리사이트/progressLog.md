# Project Progress Log - 3D 출력 생산 관리 사이트

이 문서는 프로젝트 진행 중 발생하는 주요 변경 사항, 기능 추가 및 결정 사항을 날짜별로 기록합니다.

## [2026-02-11] 
### 오후 1:25 - 무게 입력 데이터 타입 변경 (정수 -> 소수점 2자리)
- **무게 데이터 처리 고도화**:
    - 주문 생성 및 수정 시 '개당 무게(g)' 필드에 소수점 입력 허용 (`int` -> `float`).
    - 재고 관리 및 수정 시 '잔량(g)' 필드에 소수점 입력 허용.
    - 프론트엔드 입력 필드(`input type="number"`)에 `step="0.01"` 속성 추가.
    - 자바스크립트 데이터 파싱 로직을 `parseInt`에서 `parseFloat`으로 변경.

### 오후 1:15 - 프린터 자산 관리 및 입력 편의 기능 추가
- **프린터 자산 관리 기능 구현**:
    - 프린터 추가/삭제 기능.
    - 구입일(Purchase Date) 기록 및 현재 날짜 기준 경과일(D+일) 자동 계산 표시.
    - 수리일 기록을 위한 데이터 구조(Schema) 확장.
- **출력 대상명 자동완성(Datalist) 도입**:
    - 기존에 입력했던 출력물 이름을 최신순으로 드롭다운 목록에 표시.
    - 중복 제거 및 최신 데이터 우선 로직 적용.
- **API 엔드포인트 확장**:
    - `/api/v1/printers` (POST, DELETE)
    - `/api/v1/tasks/history` (GET)

### 오후 1:05 - AI 친화적 타임라인(간트) 뷰 구현
- **시각화 레이아웃 추가**:
    - HTML `<table>`과 CSS Grid를 활용한 타임라인 뷰 구현.
    - 에이전트가 데이터 구조를 즉시 파악할 수 있는 시맨틱 마크업 준수.
- **상태 연동**: 타임라인 상에서 출력 성공/불량 여부를 색상으로 구분.

### 오후 12:55 - 데이터 입력 및 상태 관리 기초 구현
- **입력 폼 추가**: 출력 예약 및 필라멘트 재고 등록 기능.
- **상태 업데이트**: 출력물별 [성공]/[불량] 버튼을 통한 실시간 상태 반영.
- **대시보드 통계**: 총 작업 수, 불량 합계 등을 실시간 계산하여 표시.

### 오전 11:30 - 프로젝트 초기화 및 설계
- **기본 폴더 구조 생성**: `00_Management` 템플릿 기반 구조 확립.
- **기술 스택 확정**: Python Flask (Backend) + JSON (DB) + Vanilla JS (Frontend).
- **요구사항 분석**: 3D 출력물 일정 및 수량 관리를 위한 설문 진행 및 데이터 스키마 정의.
- **AI 친화적 설계 원칙 수립**: Pure HTML 기반의 시맨틱 태그 및 REST API 중심 통신.

### 오후 1:25 - 데이터 저장 안정화 및 백엔드 로직 보강
- **절대 경로 기반 DB 접근**: 서버 실행 위치에 상관없이 `db.json`을 정확히 찾아 읽고 쓰도록 수정.
- **데이터 무결성 보장**: 
    - 일정 등록 시 필수 필드(ID, 상태, 생성일자) 자동 생성 로직 추가.
    - JSON 파싱 에러 발생 시 초기 데이터로 복구하는 예외 처리 추가.
- **Frontend 비동기 처리 개선**: 
    - `postData` 이후 서버 응답을 `await`로 확인하고 `fetchData`를 호출하여 화면 갱신 동기화.
    - 데이터가 없을 때의 UI 처리(테이블 내 안내 문구) 추가.
- **날짜 계산 로직 정밀화**: 구입일 기준 경과일 계산 시 시간 단위를 제외한 날짜 중심 계산 적용.

### 오후 6:25 - 필라멘트 컬러 배지(Visual Color Badge) 도입
- **시각적 가시성 강화**:
    - 재고 목록의 색상(Color) 텍스트를 실제 색상 배경의 배지로 변경.
    - 한국어 색상명(백색, 검정, 녹색, 노랑 등) 및 영문 색상명 자동 매핑 지원.
- **가독성 자동 최적화 로직**:
    - 배경색의 밝기(Luminosity)를 계산하여, 밝은 배경에는 검정 글씨, 어두운 배경에는 흰색 글씨가 자동으로 적용되도록 구현.
    - 텍스트 가독성을 보장하면서도 직관적인 재고 파악 가능.

### 오후 6:15 - 재고 목록 자동 정렬(Natural Sort) 기능 추가
- **가독성 개선**: 
    - 필라멘트 재고 목록 렌더링 시 재질(Material) 및 색상(Color) 이름순으로 자동 정렬되도록 로직 추가.
    - `localeCompare`의 숫자 정렬 모드를 활성화하여 "pla1", "pla2", "pla10" 등이 숫자 크기 순서대로 정렬되도록 구현.
- **편의성**: 사용자가 이름을 변경하더라도 리스트가 항상 정렬된 상태를 유지하여 특정 항목을 찾기 쉬워짐.

### 오후 6:00 - 시간 기반 정밀 재고 차감 로직 업그레이드
- **이중 차감 방지 로직 도입**:
    - 재고 입력(저울 측정값 입력) 시점과 생산 실적 입력 시점이 겹칠 때 발생하는 데이터 오류를 방지하기 위해 **시간 비교 로직** 추가.
    - 각 필라멘트 재고의 `updated_at`(기록 시간) 이후에 생성된 생산 실적(`created_at`)만 소모량으로 계산.
- **기대 효과**: 
    - 사용자가 저울로 재고를 실측하여 업데이트하는 순간, 시스템은 그 이전의 모든 소모 기록을 무시하고 새 측정값을 기준으로 다시 소모량을 추적함.
    - "생산 전 무게"든 "생산 후 무게"든 관계없이 입력한 시점만 명확하면 항상 정확한 추정 잔량 유지 가능.

### 오후 5:40 - 감사 로그(Audit Log) 시스템 도입
- **데이터 변경 이력 로깅**:
    - 모든 생성(CREATE), 수정(UPDATE), 삭제(DELETE) 요청 발생 시 `data/user_actions.log` 파일에 즉시 기록.
    - 기록 항목: 작업 시간, 요청자 IP 주소, 작업 유형, 대상 ID, 변경 상세 내용.
- **책임 소재 명확화**: 
    - 다수의 사용자가 이용할 경우, 누가 어떤 데이터(주문, 일정, 재고, 프린터)를 언제 변경했는지 추적할 수 있는 기반 마련.

### 오후 5:25 - 재고 및 프린터 수정 기능 복구 및 타임라인 뷰 보강
- **버그 수정**: 
    - 필라멘트 재고 및 프린터 자산 리스트의 '수정' 버튼 클릭 시 팝업이 뜨지 않던 문제 해결.
    - 비어있던 `openInventoryEdit`, `openPrinterEdit` 등 관련 JavaScript 함수들을 실제 데이터 바인딩 로직과 함께 구현.
- **타임라인(간트) 뷰 구현**:
    - 비어있던 `renderTimeline` 함수를 구현하여 향후 7일간의 프린터별 가동 일정을 시각적으로 확인할 수 있도록 보강.
    - 작업 상태(완료/대기)에 따라 색상 구분 반영.

### 오후 5:10 - 필라멘트 재고 기록 시간(Timestamp) 관리 기능 추가
- **정밀한 시간 추적 도입**: 
    - 재고를 새로 등록하거나 잔량을 수정할 때마다 **날짜와 시간(`YYYY-MM-DD HH:mm:ss`)을 자동으로 기록**.
    - 이를 통해 해당 무게 데이터가 생산 전, 생산 중, 혹은 생산 후에 측정된 것인지 명확히 파악 가능.
- **백엔드/프런트엔드 연동**:
    - `db.json` 내 `inventory` 객체에 `updated_at` 필드 추가.
    - 재고 관리 테이블에 **'기록 시간'** 컬럼을 신설하여 최신 업데이트 시점을 상시 노출.

### 오후 4:55 - 생산 실적 기반 실시간 필라멘트 소모 로직 반영
- **추정 잔량(Estimated Stock) 계산 도입**:
    - 단순히 `재고 - 미래 필요량`을 비교하던 방식에서, **`등록 재고 - 현재까지의 소모량(실적 기반)`**을 통해 현재 스풀에 남아있을 실제 양을 먼저 추정하도록 개선.
    - 소모량 계산식: `해당 재질/색상을 사용하는 모든 주문의 생산 실적 합계 * 개당 무게`.
- **판단 기준 고도화**:
    - `추정 잔량` vs `향후 필요량(잔여 수량 * 개당 무게)`을 비교하여 수급 상태를 판정.
- **UI 정보 구체화**:
    - 재고 목록에 '등록 무게'와 별개로 시스템이 계산한 **'추정 잔량'**을 명시하여 사용자가 실제 스풀 무게와 비교해볼 수 있도록 지원.

### 오후 4:40 - 필라멘트 수급 현황 가시성 개선
- **종류별 통합 수급 판정 로직 도입**:
    - 개별 필라멘트 스풀 단위로 필요량을 표시하던 방식에서, **재질/색상별 전체 재고와 전체 필요량을 합산 비교**하는 방식으로 개선.
    - 동일한 PLA 블랙 필라멘트가 여러 개 있어도, 전체 합계가 필요량보다 많으면 **'재고 충분'** 상태로 표시되어 사용자 혼동 방지.
- **상태 메시지 구체화**:
    - **재고 충분**: 초록색 텍스트로 여유 수량(Total Stock - Total Need)을 함께 표시.
    - **재고 부족**: 빨간색 텍스트로 실제 부족분(Total Need - Total Stock)만 표시하고 행 전체를 주황색으로 강조.
- **UI 최적화**: 천 단위 구분 쉼표(toLocaleString) 적용 및 불필요한 중복 텍스트 제거.

### 오후 4:20 - 실적 입력 로직 고도화 및 UI 용어 수정
- **실적 누적(+) 시스템 도입**: 
    - 한 일정에 대해 여러 번 실적을 입력해도 기존 값에 더해지도록 수정 (예: 10개 입력 후 다시 5개 입력 시 총 15개로 기록).
- **계획 초과분 자동 처리**: 
    - 특정 날짜에 계획보다 많이 생산할 경우, 동일 주문의 **미래 일정(Pending)에서 초과분만큼 계획 수량을 자동 차감**.
    - 이를 통해 전체 생산 일정이 실질적으로 앞당겨지는 효과 반영.
- **UI 용어 직관화**:
    - 주문 카드 내 '추가 필요량' 문구를 **'필요 필라멘트'**로 변경하여 용도 명확화.
    - 실적 입력 프롬프트에 '(누적됨)' 안내 추가.

### 오후 3:30 - 프린터 가용 일정 시각화 (Flatpickr 도입)
- **달력 UI 고도화**:
    - Flatpickr 라이브러리를 도입하여 HTML 기본 날짜 입력기의 시각적 한계 극복.
- **가용성 시각화 로직**:
    - 프린터 선택 시, 해당 장비의 기존 일정(Busy Dates)을 서버에서 조회.
    - 달력 팝업 내에서 **예약된 날짜는 회색으로 비활성화** 처리하여 중복 선택 원천 차단.
    - **선택 가능 날짜는 녹색** 톤으로 스타일링하여 가용성 직관적 파악 가능.
- **모드별 UI 최적화**:
    - 자동 계획 모드: 날짜 선택만 가능 (`YYYY-MM-DD`).
    - 수동 할당 모드: 시간까지 선택 가능 (`YYYY-MM-DD HH:mm`).

### 오후 3:15 - 생산 일정 리스트 가독성 및 정렬 개선
- **날짜 중심 정렬**: 모든 생산 계획을 날짜순(오름차순)으로 자동 정렬하여 공정 흐름 가시성 확보.
- **생산품별 시각적 분리**: 
    - 리스트 출력 중 생산품(주문)이 변경될 때마다 회색 구분 행(`product-separator`)을 삽입하여 그룹화.
- **2줄 레이아웃 적용**:
    - 한 행 내에서 제품명/재질, 계획/실적 수량 등을 2줄로 배치하여 정보를 더 여유롭게 표시.
- **컬럼 재배치**: 사용자 요청에 따라 날짜를 최우측에서 최좌측으로 이동 및 관리 버튼 배치 최적화.

### 오후 2:55 - 주문 등록 UI 개선 및 필라멘트 선택 자동화
- **입력 편의성 강화**: 
    - 주문 등록 시 '기존 재고 수량' 칸에 placeholder 안내 문구 추가 및 기본값(`0`) 제거.
    - 재질 및 색상을 텍스트 입력 대신 **현재 보유 재고 목록**에서 선택할 수 있도록 드롭다운(Select) 방식으로 변경.
- **동적 데이터 바인딩**: 재고가 추가되거나 수정되면 주문 등록/수정 창의 필라멘트 목록도 실시간으로 동기화됨.

### 오후 2:45 - 필라멘트 소요량 예측 및 부족 경고 시스템
- **주문 상세 정보 확장**: 주문 등록 시 `재질(Material)`, `색상(Color)`, `개당 무게(Unit Weight)` 정보를 입력.
- **소요량 자동 계산**: 
    - `주문별 필요량` = (목표 수량 - 확보 수량) × 개당 무게.
    - 주문 카드에 '추가 필요 필라멘트 양' 표시.
- **재고 부족 경고**:
    - 동일한 재질/색상을 사용하는 모든 진행 중인 주문의 총 필요량을 합산.
    - 현재 보유 재고가 필요량보다 적을 경우, 재고 리스트에 **주황색 배경**과 함께 **부족 수량(필요량)**을 빨간색 텍스트로 표시.

### 오후 2:35 - 필라멘트 재고 및 프린터 자산 수정 기능 추가
- **관리 편의성 강화**: 등록된 필라멘트 재고 정보(재질, 색상, 무게)와 프린터 정보(모델, 식별번호, 구입일)를 언제든 수정할 수 있는 기능 추가.
- **삭제 기능 보강**: 불필요한 재고 항목을 삭제할 수 있는 API 및 UI 연동.
- **UI 일관성**: 주문 수정과 동일하게 오버레이 팝업 형태의 수정 인터페이스 적용.

### 오후 2:25 - 프린터 중복 할당 감지(Conflict Detection) 및 자산 ID 추가
- **프린터 식별 강화**: 기존 모델명 외에 고유 식별 번호(`asset_id`) 필드 추가 (예: P2SC-101).
- **중복 할당 경고 로직**:
    - 동일 프린터가 같은 날짜에 여러 개의 스케줄을 가질 경우, 시스템이 이를 감지하여 경고 발생.
    - 자동 계획 생성(`Auto-Schedule`) 시에도 중복 날짜를 감지하여 결과 메시지에 리포트.
- **UI 시각화**: 중복된 스케줄 행은 주황색 배경(`warning-color`)으로 표시되며, '[중복!]' 태그가 붙음.

### 오후 2:15 - 주문 수정(Order Edit) 기능 추가
- **주문 정보 업데이트**: 이미 등록된 주문의 제품명, 목표 수량, 기존 재고, 마감 기한을 수정할 수 있는 기능 추가.
- **상태 재계산 로직**: 목표 수량이나 기존 재고 수정 시, 현재까지의 생산 실적과 비교하여 주문 상태(진행중/완료)를 자동으로 재설정.
- **UI 구현**: 각 주문 카드에 '수정' 버튼 추가 및 오버레이 형태의 수정 폼 구현.

### 오후 2:05 - 주문별 기존 재고(Initial Stock) 반영 기능 추가
- **기존 재고 관리**: 주문 등록 시 '기존 재고 수량'을 입력할 수 있도록 필드 추가.
- **계산 수식 고도화**:
    - **잔여 생산 필요량** = 목표 수량 - 기존 재고 - 누적 생산 실적.
    - **전체 확보량** = 기존 재고 + 생산 실적.
- **자동 스케줄링 연동**: 자동 계획 생성 시, 목표 수량에서 기존 재고를 제외한 '진짜 필요한 생산량'만큼만 일정을 생성하도록 API 로직 수정.
- **UI 업데이트**: 주문 카드에 (재고 + 생산) 합산 정보를 상세히 표시하여 직관적인 현황 파악 가능.

### 오후 1:55 - 생산 계획 자동 생성(Auto-Scheduling) 기능 추가
- **기능 개요**: 시작일과 일일 목표 생산량(Capa)을 입력하면, 주문의 잔여 수량을 채울 때까지의 일별 생산 계획을 자동으로 계산하여 일괄 생성.
- **백엔드 로직**: 
    - `/api/v1/schedules/auto` 엔드포인트 신설.
    - 잔여 수량(`remaining_qty`)이 0이 될 때까지 루프를 돌며 일별 계획 생성.
    - 마지막 날짜는 남은 수량만큼만 할당.
- **UI/UX**: 
    - [자동 계획 생성 모드] 체크박스를 통해 단일 등록/일괄 등록 UI 전환.
    - 완료 후 생성된 계획 개수 알림 팝업 제공.

### 오후 1:45 - 생산 계획 삭제 기능 추가
- **삭제 버튼 및 확인 팝업**: 생산 일정 리스트에 [삭제] 버튼 추가 및 삭제 시 확인 팝업(`confirm`) 연동.
- **실적 연동 삭제**: 특정 일정을 삭제하면 해당 일정이 기여했던 주문의 '누적 완료 수량'이 자동으로 차감되어 계산되도록 백엔드 로직 보강.

### 오후 1:35 - 생산 관리 시스템 (MES Lite) 구조 개편
- **주문(Order) 중심 아키텍처 도입**:
    - 전체 생산 목표를 정의하는 '주문'과 실행 단위인 '일정'으로 계층화.
    - 주문 카드 UI: 목표, 완료, 잔여 수량 및 진행률 바 시각화.
- **실적 기반 자동 계산**:
    - 일일 생산 실적 입력 시 주문의 잔여 수량이 자동으로 차감되는 수식 적용.
- **데이터 마이그레이션**: 기존 `schedules` 구조에 `order_id`와 `actual_quantity` 필드 추가.

---
*Next Step: 사진 업로드 기능 또는 상세 통계 리포트 구현 예정*
