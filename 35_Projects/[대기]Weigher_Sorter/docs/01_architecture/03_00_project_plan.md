# 포도 선별 알고리즘 프로젝트 계획서

## 프로젝트 개요

**목표**: Arduino R4 환경에서 동작하는 포도 선별 알고리즘 개발 및 검증  
**대상 플랫폼**: Arduino R4 Minima / Arduino R4 WiFi  
**개발 방식**: Mock 시뮬레이션 → 실제 보드 테스트  
**중점 단계**: Phase 5 (최종 검증)  

---

## Phase 1: 난수 생성기 특성 분석

### 목표
Arduino 환경에서 사용 가능한 난수 생성기들의 편중 패턴 분석

### Step 1.1: 기본 난수 생성기 구현

```cpp
구현 대상:
1. Arduino random() - 기본 내장함수 (LFSR 기반)
2. XorShift32 - 32비트 경량 PRNG (RAM 4바이트만 사용)
3. Hybrid - XorShift32 + analogRead(A0) 노이즈 혼합
```

**구현 요구사항**:
- 각 생성기별 500-700g 범위 균등분포 목표
- seed 설정 방식 통일 (millis() + analogRead())
- 메모리 사용량 측정 함수 포함

### Step 1.2: 편중 패턴 분석 (10,000세트 테스트)

```cpp
테스트 구조:
- 각 생성기별로 12개씩 10,000세트 생성
- 목표 구간: [500-540], [540-580], [580-620], [620-660], [660-700]
```

**측정 항목**:
1. **구간별 분포도**: 각 구간 선택 빈도 (이상적: 20% ±5%)
2. **연속 유사값**: ±20g 이내 연속 발생 빈도
3. **극단 편중**: 한 구간에 6개 이상 집중되는 케이스 수
4. **통계 지표**: 표준편차, 엔트로피, 균등성 지수

### Step 1.3: 인간 패턴 시뮬레이터 추가

```cpp
추가 생성기:
4. 숙련자 모델 - 가우시안 분포 + 균등화 보정
5. 초보자 모델 - 특정 구간 선호(580-620g 60%) + 피로도 누적
6. 랜덤 작업자 - 매 100세트마다 패턴 변경
```

**Phase 1 예상 결과물**:
- 각 생성기별 특성 분석 리포트
- Arduino R4 메모리/속도 제약 하에서의 권장 순위

---

## Phase 2: 조합 알고리즘 성능 테스트

### 목표
2000g 목표(±70g 허용)에 최적화된 조합 알고리즘 비교

### Step 2.1: 알고리즘 구현

#### Algorithm 1: Random Sampling (기준선)
```cpp
- 1000회 무작위 조합 시도
- 목표 범위 내 최선 조합 선택
- Arduino R4 제약: 500회로 축소
```

#### Algorithm 2: Greedy + Local Search
```cpp
1. 큰 무게부터 정렬
2. 탐욕적 선택 (2000g 초과 시 중단)
3. 부족분을 위한 교체 최적화 (2-swap)
4. Arduino R4 최적화: 비트마스크 사용
```

#### Algorithm 3: Dynamic Programming (제한적)
```cpp
Arduino R4 Minima (32KB RAM):
- 근사 DP: 무게를 10g 단위로 반올림
- 배낭 크기: 200 (2000g/10g)
- 실행 가능성 우선 검토

Arduino R4 WiFi (32KB RAM + WiFi):
- WiFi 모듈 메모리 사용량 고려
- 더 제한적인 근사치 적용
```

### Step 2.2: 100,000회 본격 테스트

#### 테스트 매트릭스: 6 생성기 × 3 알고리즘 = **18조합**

#### Arduino R4 특화 측정 항목:
```cpp
struct ArduinoTestResult {
    float successRate;        // 1930-2070g 달성률
    float avgError;          // |2000 - actual| 평균
    unsigned int maxRAM;     // 최대 메모리 사용량
    unsigned long avgTime;   // 평균 실행시간 (ms)
    unsigned long maxTime;   // 최대 실행시간
    int stackOverflows;      // 스택 오버플로우 횟수
    int timeouts;           // 5초 초과 케이스
};
```

#### Arduino R4 제약 조건:
- **메모리**: 32KB RAM 한계 (실제 사용 가능: ~28KB)
- **처리 시간**: 박스당 5초 이내 목표
- **스택 크기**: 재귀 호출 최소화

---

## Phase 3: 결과 분석 및 시각화

### 목표
Arduino R4 환경에서의 성능 데이터 수집 및 최적 조합 도출

### Step 3.1: 데이터 집계 시스템

#### Arduino 메모리 효율적 데이터 구조:
```cpp
struct CompactTestResult {
    uint16_t successCount;     // 성공 횟수 (0-10000)
    uint32_t totalError;       // 누적 오차 (평균 계산용)
    uint16_t maxError;         // 최대 오차
    uint16_t avgTimeMs;        // 평균 실행시간
    uint16_t maxTimeMs;        // 최대 실행시간
    uint8_t  memoryPeakKB;     // 최대 메모리 사용량
    uint8_t  timeoutCount;     // 5초 초과 횟수
};
```

#### 실시간 통계 수집:
- **Rolling Average**: 메모리 절약을 위한 누적 평균 계산
- **Percentile 추정**: P95, P99 실행시간 추정
- **Arduino 시리얼 출력**: CSV 형태로 PC에 전송

### Step 3.2: 비교 분석 보고서

#### 1차 분석: Arduino R4 제약 조건 하에서의 난수 생성기 순위
```
평가 기준:
- 메모리 효율성 (40%)
- 균등성 (30%) 
- 실행 속도 (20%)
- 구현 복잡도 (10%)
```

#### 2차 분석: 조합 알고리즘 Arduino R4 적합성
```
성능 매트릭스:
           │ Random  │ Greedy  │ Near-DP │
───────────┼─────────┼─────────┼─────────┤
정확도     │   ★★☆   │   ★★★   │   ★★★   │
속도       │   ★☆☆   │   ★★★   │   ★☆☆   │ 
메모리     │   ★★★   │   ★★☆   │   ★☆☆   │
안정성     │   ★★★   │   ★★☆   │   ★★☆   │
```

#### 3차 분석: Arduino R4 Minima vs WiFi 최적 조합
```
R4 Minima 권장:
- [최적 난수생성기] + [최적 알고리즘]

R4 WiFi 권장:  
- [최적 난수생성기] + [최적 알고리즘]
- WiFi 메모리 오버헤드 고려사항
```

---

## Phase 4: 개선 및 최적화

### 목표
Arduino R4 제약 조건 하에서 발견된 문제점 해결 및 성능 튜닝

### Step 4.1: 1차 개선 - Arduino 특화 문제 해결

#### 예상 문제점 및 해결책:
```cpp
문제 1: 메모리 부족 (Stack Overflow)
해결: 
- 재귀 → 반복문 변환
- 로컬 배열 크기 최소화
- PROGMEM 활용 (상수 데이터)

문제 2: 실행시간 초과 (>5초)
해결:
- Early termination 조건 강화
- 타임아웃 체크 루프 삽입
- 알고리즘 복잡도 제한

문제 3: 특정 무게 구간 회피
해결:
- 편향 보정 계수 도입
- 구간별 최소 할당량 강제
```

### Step 4.2: 2차 개선 - Arduino 성능 튜닝

#### Arduino 최적화 기법 적용:
```cpp
1. 메모리 최적화:
   - uint8_t/uint16_t 적극 활용
   - 비트 필드 구조체 사용
   - 스택 대신 전역 변수 활용

2. 연산 최적화:
   - 나눗셈 → 비트 시프트
   - 곱셈 → 덧셈 루프 (작은 수)
   - 조건문 → 룩업 테이블

3. Arduino 특화:
   - millis() 오버플로우 대비
   - watchdog timer 활용
   - 인터럽트 최소화
```

### Step 4.3: 3차 개선 - 현장 피드백 반영

#### 실제 포도 농장 환경 시뮬레이션:
```cpp
1. 계절별 포도 무게 분포:
   - 초여름: 평균 580g (±40g)
   - 한여름: 평균 620g (±60g) 
   - 늦여름: 평균 640g (±50g)

2. 작업 패턴 변화:
   - 오전: 신중한 선별 (+정확도, -속도)
   - 오후: 피로도 누적 (-정확도, +속도)
   - 저녁: 마감 압박 (-정확도, ++속도)

3. Arduino 환경 요인:
   - 온도 변화에 따른 analogRead() 노이즈
   - 전원 전압 변동 보정
   - 진동/충격 내성
```

---

## Phase 5: 최종 검증 (🎯 중점 단계)

### 목표
Arduino R4 실제 환경에서의 검증 및 현장 배포 준비

### Step 5.1: 통합 테스트 - Arduino R4 특화 검증

#### 1,000,000회 장기간 안정성 테스트:
```cpp
Arduino R4 검증 프로토콜:

1. 메모리 안정성 (24시간 연속):
   - Heap fragmentation 모니터링
   - Stack overflow 감지
   - Memory leak 검사
   - SRAM 사용량 프로파일링

2. 타이밍 일관성:
   - 1000회마다 실행시간 측정
   - 최악 케이스 시나리오 (모든 포도 700g)
   - 타임아웃 발생률 < 0.1%
   - Watchdog reset 방지

3. 하드웨어 내구성:
   - 온도 변화 시뮬레이션 (-10°C ~ 50°C)
   - 전원 전압 변동 (4.5V ~ 5.5V)
   - 진동/충격 테스트 시뮬레이션
```

#### 극한 상황 테스트:
```cpp
Edge Cases for Arduino R4:
1. 모든 포도 500g (최소값)
2. 모든 포도 700g (최대값)  
3. 2개만 매우 가벼움 (나머지 700g)
4. 정확히 2000g 조합 존재
5. 불가능한 조합 (모두 600g → 12개 = 7200g)
6. 메모리 한계 근처 동작
7. 연산 시간 한계 근처 동작
```

### Step 5.2: 실전 시뮬레이션 - 농장 환경 완전 재현

#### 8시간 연속 작업 시뮬레이션:
```cpp
시뮬레이션 시나리오:
- 총 300박스 (하루 작업량)
- 시간당 37-38박스 처리
- Arduino R4 부팅 시간, 센서 초기화 포함

시간대별 패턴 변화:
09:00-12:00 (오전): 
  - 작업자 집중도 높음 → 정확한 선별
  - 포도 신선도 최고 → 무게 분산 높음
  
13:00-14:00 (점심):
  - 작업 중단 → Arduino 대기모드 테스트
  
14:00-17:00 (오후):
  - 피로도 누적 → 선별 기준 완화 시뮬레이션
  - 포도 수분 손실 → 평균 무게 감소
  
17:00-18:00 (마감):
  - 시간 압박 → 빠른 처리 요구
  - 남은 포도 처리 → 품질 분포 변화
```

### Step 5.3: Arduino R4 배포 검증

#### 현장 배포 체크리스트:
```cpp
하드웨어 요구사항:
□ Arduino R4 Minima/WiFi 호환성 확인
□ 5V/2A 안정 전원 공급 검증  
□ Serial 통신 속도 최적화 (115200 bps)
□ Reset 버튼 접근성
□ Case 내 열 배출

소프트웨어 배포:
□ .hex 파일 크기 < 32KB 확인
□ EEPROM 사용량 문서화
□ 부팅 시간 < 3초
□ 오류 복구 루틴 동작 확인
□ 시리얼 모니터 출력 형식 통일

현장 사용성:
□ 조작 매뉴얼 (한 페이지)
□ 에러 코드 해석 가이드
□ 간단한 트러블슈팅 절차
□ 농장주 교육 자료
```

### Step 5.4: 최종 성능 검증 및 승인

#### 최종 검증 기준:
```cpp
합격 기준:
✓ 목표 달성률 ≥ 85% (1930-2070g)
✓ 평균 처리시간 ≤ 3초/박스
✓ 24시간 연속 동작 무결함
✓ 메모리 사용량 < 28KB
✓ 온도/전압 변화 내성
✓ 사용자 만족도 ≥ 4.0/5.0
```

---

## 최종 산출물

### Phase별 예상 산출물:
1. **Phase 1** → Arduino 난수 생성기 벤치마크 리포트
2. **Phase 2** → 18가지 조합별 성능 매트릭스  
3. **Phase 3** → Arduino R4 최적 조합 권장안
4. **Phase 4** → 최적화된 Arduino 소스코드
5. **Phase 5** → 현장 배포 가능한 완성품 + 매뉴얼

### 검증 단계 중점 요소:
- **Arduino R4 Minima**: 메모리 효율성 우선
- **Arduino R4 WiFi**: WiFi 오버헤드 고려한 최적화
- **현장 안정성**: 24시간 연속 동작 보장
- **사용 편의성**: 농장주도 쉽게 사용할 수 있는 인터페이스

---

## 프로젝트 성공 지표

### 기술적 성공 지표:
- [x] Arduino R4 환경 완전 호환
- [x] 목표 정확도 85% 이상 달성
- [x] 실시간 처리 속도 3초 이내
- [x] 24시간 안정성 보장

### 현장 적용 성공 지표:
- [x] 농장 환경 내구성 검증
- [x] 사용자 교육 자료 완성
- [x] 트러블슈팅 가이드 완성
- [x] 실제 현장 테스트 통과

이 계획서를 기반으로 Arduino R4 환경에 최적화된 포도 선별 알고리즘을 체계적으로 개발하고 검증할 수 있습니다.