# 04_codeTest.ino 코드 리뷰

## 개요
본 문서는 `04_codeTest.ino` 파일의 코드를 분석하고 리뷰한 내용입니다. 이 코드는 온/오프 시간을 지정하여 서보모터를 제어하는 프로그램의 테스트 버전으로, 시간 단위를 분에서 초로 변경하여 더 빠르게 테스트할 수 있도록 설계되었습니다.

## 주요 기능

1. **테스트 모드 구현**
   - 시간 단위를 분 → 초로 변경하여 테스트 시간 단축
   - 사이클 카운트 기능으로 테스트 진행 상황 확인 가능
   - 최대 테스트 사이클 수 설정 및 완료 알림

2. **서보모터 제어**
   - 두 개의 서보모터를 동시에, 동일하게 제어
   - ON/OFF 상태에 따른 각도 제어 (0° 또는 180°)

3. **가변저항을 통한 시간 제어**
   - 첫 번째 가변저항(A0): ON 시간 조절(초 단위)
   - 두 번째 가변저항(A1): OFF 시간 조절(초 단위)

4. **실시간 상태 표시**
   - OLED 디스플레이에 현재 상태, 설정 시간, 사이클 정보 표시
   - 시리얼 모니터에 상세한 디버깅 정보 제공
   - 남은 시간 카운트다운 표시

## 코드 구조 분석

### 라이브러리 및 설정
```cpp
#include <U8glib.h>   // OLED 디스플레이 제어
#include <DHT.h>      // 온습도 센서 제어
#include <Servo.h>    // 서보모터 제어
```

다양한 하드웨어 모듈을 제어하기 위한 라이브러리들을 적절히 포함하고 있습니다.

### 주요 변수 설정

```cpp
// 서보모터 설정
Servo servo, servo2;

// 가변저항 설정
int potentioPin = A0, potentioPin2 = A1;

// 시간 관련 변수
int matchingTime = 30;  // 최대 30초
int minTimeValue = 1;   // 최소 1초

// 테스트 모드 관련 정보
bool testMode = true;
int cycleCount = 0;
int maxCycles = 10;     // 최대 테스트 사이클 수
```

변수들이 기능별로 잘 구분되어 있어 코드 가독성이 좋습니다. 특히 테스트 모드를 위한 변수들이 명확히 정의되어 있습니다.

### 핵심 함수 분석

#### 1. `setup()` 함수
```cpp
void setup() {
  // 시리얼 통신 초기화
  Serial.begin(115200);
  
  // DHT 센서 초기화
  dht.begin();
  
  // 서보모터 초기화
  servo.attach(servoPin);
  servo2.attach(servoPin2);
  
  // 서보모터 초기 위치 설정
  servo.write(0);
  delay(500);
  servo2.write(0);
  delay(500);
  
  Serial.println("==== 테스트 모드 시작 ====");
  Serial.println("가변저항 1: ON 시간 설정 (초)");
  Serial.println("가변저항 2: OFF 시간 설정 (초)");
}
```

초기화 작업이 체계적으로 되어 있으며, 테스트 모드 시작 안내 메시지를 통해 사용자에게 명확한 지침을 제공합니다.

#### 2. `water_motor_control()` 함수
```cpp
void water_motor_control() {
  if ((motorState == HIGH && currentMillis - previousMillis >= intervalOn) ||
      (motorState == LOW && currentMillis - previousMillis >= intervalOff)) {
      
    previousMillis = currentMillis;
    
    if (motorState == LOW) {
      motorState = HIGH;
      servoAngle = 0;
      servo2Angle = 0;
      cycleCount++;
      Serial.print("사이클 #");
      Serial.print(cycleCount);
      Serial.println(" - 모터 ON");
    } else {
      motorState = LOW;
      servoAngle = 180;
      servo2Angle = 180;
      Serial.print("사이클 #");
      Serial.print(cycleCount);
      Serial.println(" - 모터 OFF");
    }
    
    servo.write(servoAngle);
    servo2.write(servo2Angle);
    
    // 테스트 모드에서 최대 사이클 도달 시 알림
    if (testMode && cycleCount >= maxCycles) {
      Serial.println("==== 테스트 사이클 완료 ====");
      Serial.print("총 사이클 수: ");
      Serial.println(cycleCount);
    }
  }
}
```

이 함수는 타이머 제어 로직과 서보모터 제어를 효과적으로 결합하고 있습니다. 특히 다음과 같은 우수한 점이 있습니다:
- 사이클 카운트 증가 및 표시
- 상태 변화 기록
- 테스트 완료 시점 감지 및 알림

#### 3. `potentiometerMapping()` 및 `potentiometerMapping2()` 함수
```cpp
void potentiometerMapping() {
  potentioValue = analogRead(potentioPin);
  
  // 가변저항 값을 1~30초 범위로 매핑
  potentioMappingValue = map(potentioValue, 0, 1023, 1, matchingTime);
  
  // 최소 1초 보장
  selectTime = potentioMappingValue;
  if (selectTime < minTimeValue) {
    selectTime = minTimeValue;
  }
  
  // ON 시간 간격 설정 (밀리초 단위)
  intervalOn = (long)selectTime * 1000L; // 초 단위를 밀리초로 변환
}
```

가변저항 값을 읽고 적절한 시간 값으로 매핑하는 로직이 명확합니다. 최소값 보장 기능이 포함되어 있어 안정적인 동작을 보장합니다.

#### 4. `serialPrint()` 함수
```cpp
void serialPrint() {
  if (currentMillis - previousMillis3 >= 1000) {  // 1초마다 출력
    previousMillis3 = currentMillis;
    
    // 다양한 상태 정보 출력
    // ...
    
    // 남은 시간 표시
    unsigned long remainingTime;
    if (motorState == HIGH) {
      remainingTime = (intervalOn - (currentMillis - previousMillis)) / 1000;
      Serial.print("남은 ON 시간: ");
    } else {
      remainingTime = (intervalOff - (currentMillis - previousMillis)) / 1000;
      Serial.print("남은 OFF 시간: ");
    }
    Serial.print(remainingTime);
    Serial.println("초");
    
    Serial.println("-----------------------");
  }
}
```

체계적인 디버깅 정보 출력 함수로, 특히 남은 시간 카운트다운 표시 기능이 사용자 편의성을 높여줍니다.

## 개선된 사항

이전 버전(`03_powerOnOffRepeat.ino`)에 비해 다음과 같은 개선 사항이 있습니다:

1. **테스트 효율성 향상**
   - 분 단위에서 초 단위로 변경하여 테스트 시간 단축
   - 사이클 카운터 추가로 테스트 진행상황 모니터링 가능

2. **사용자 인터페이스 개선**
   - OLED 디스플레이에 더 많은 정보 표시(사이클 카운트, 시간 설정값)
   - 시리얼 출력에 남은 시간 카운트다운 표시 추가

3. **안정성 및 피드백**
   - 사이클 상태 변화 알림 추가
   - 테스트 완료 시점 명확히 표시

4. **디버깅 기능 강화**
   - 1초마다 상태 정보 업데이트로 실시간 모니터링 가능성 향상
   - 더 상세한 정보 출력(남은 시간, 각도, 상태 등)

## 제안 사항

코드 개선을 위한 제안 사항은 다음과 같습니다:

1. **코드 모듈화 강화**
   - 테스트 모드와 일반 모드를 설정으로 전환할 수 있는 기능 추가
   - 설정값을 변경할 수 있는 UI 또는 명령어 인터페이스 추가

2. **에러 처리 강화**
   - 센서 연결 실패 또는 서보모터 오류 시 대응 메커니즘 추가
   - 가변저항 연결 상태 확인 기능

3. **에너지 효율성**
   - 필요한 경우에만 디스플레이 및 시리얼 출력 업데이트
   - 불필요한 센서 읽기 최소화

4. **사용자 경험(UX) 개선**
   - OLED에 남은 시간 카운트다운 표시
   - 진행 중인 작업의 시각적 표현 강화(예: 프로그레스 바)

## 결론

`04_codeTest.ino`는 온/오프 모터 제어 시스템의 효율적인 테스트를 위해 잘 설계된 코드입니다. 시간 단위를 초로 변경하고 사이클 카운트 기능을 추가함으로써 테스트 과정을 더 빠르고 명확하게 만들었습니다. OLED 디스플레이와 상세한 시리얼 출력을 통해 시스템 상태를 실시간으로 모니터링할 수 있으며, 다양한 시간 설정이 가능합니다.

이 테스트 코드는 실제 환경에서의 장시간 동작을 검증하기 전에 시스템의 기본 기능을 확인하는 데 매우 유용한 도구입니다. 몇 가지 제안된 개선 사항을 적용한다면 더욱 완성도 높은 테스트 환경이 될 것입니다.