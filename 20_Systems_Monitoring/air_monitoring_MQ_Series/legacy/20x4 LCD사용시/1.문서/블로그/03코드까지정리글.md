# MQ135 가스 센서와 LCD를 이용한 대기질 모니터링 시스템 구현하기

## 1. 개요
이 글에서는 Arduino를 사용하여 MQ135 가스 센서로 여러 가지 대기 성분을 측정하고, LCD 디스플레이를 통해 측정값을 표시하는 시스템을 구현하는 방법을 설명합니다. 전체 시스템은 크게 MQ135 센서 부분과 LCD 디스플레이 부분으로 나뉩니다.

## 2. 필요한 라이브러리와 하드웨어 설정

### 사용된 라이브러리
```cpp
#include <MQUnifiedsensor.h>
#include <LiquidCrystal_PCF8574.h>
```
- MQUnifiedsensor: MQ135 센서 데이터를 읽고 처리하기 위한 라이브러리
- LiquidCrystal_PCF8574: I2C 통신을 이용한 LCD 제어 라이브러리

### 하드웨어 설정
- MQ135 센서는 Arduino의 A0 핀에 연결
- LCD는 I2C 통신(주소: 0x27)을 통해 연결
- LCD는 20x4 크기(20열 4행)로 설정

## 3. MQ135 센서 관련 코드 설명

### 센서 초기화 및 캘리브레이션
```cpp
void setup_MQ135()
{
    MQ135.setRegressionMethod(1);
    MQ135.init();
    // 캘리브레이션 과정
    float calcR0 = 0;
    for (int i = 1; i <= 10; i++)
    {
        MQ135.update();
        calcR0 += MQ135.calibrate(RatioMQ135CleanAir);
    }
    MQ135.setR0(calcR0 / 10);
}
```
- 센서 초기화 시 회귀 방법을 설정하고 10회의 캘리브레이션을 수행
- RatioMQ135CleanAir 값(3.6)을 기준으로 센서를 보정
- 캘리브레이션 결과로 얻은 R0 값을 센서에 설정

### 가스 측정 코드
```cpp
void loop_MQ135()
{
    MQ135.update();
    
    // 각 가스별 계수 설정 및 측정
    // CO 측정
    MQ135.setA(605.18); MQ135.setB(-3.937);
    CO = MQ135.readSensor();
    
    // CO2 측정
    MQ135.setA(110.47); MQ135.setB(-2.862);
    CO2 = MQ135.readSensor();
    // ... 기타 가스 측정
}
```
- 6가지 가스(CO, Alcohol, CO2, Toluene, NH4, Acetone) 측정
- 각 가스마다 고유한 A, B 계수를 설정하여 PPM 농도 계산
- CO2의 경우 대기 중 기본 농도 400ppm을 보정값으로 추가

## 4. LCD 디스플레이 관련 코드 설명

### LCD 초기화
```cpp
void setup_LCD()
{
    lcd.begin(LCD_COLUNMS, LCD_ROWS);
    lcd.setBacklight(80);
}
```
- LCD의 크기(20x4)를 설정하고 백라이트 밝기 조정

### 데이터 표시 형식 정렬
```cpp
void printAligned(float value, int row, const char *label)
{
    int intPart = (int)value;
    int intDigits = (intPart == 0) ? 1 : (log10(abs(intPart)) + 1);
    int decimalPos = 12 - intDigits;
    // ... 정렬된 출력 로직
}
```
- 측정값을 LCD에 깔끔하게 정렬하여 표시
- 정수부 자릿수를 계산하여 소수점 위치를 동적으로 조정
- 각 행에 가스 이름, 측정값, 단위(ppm)를 표시

### 화면 전환 시스템
```cpp
void loop()
{
    // 10초마다 화면 전환
    unsigned long currentInterval = (millis() / 1000) % DISPLAY_CYCLE;
    bool shouldDisplayMain = (currentInterval < MAIN_CYCLE);
    
    if (shouldDisplayMain != displayingMain)
    {
        lcd.clear();
        displayingMain = shouldDisplayMain;
    }
    // ... 화면 표시 로직
}
```
- 메인 화면(CO, CO2, NH4)과 서브 화면(Acetone, Alcohol, Toluene) 간 자동 전환
- 10초 주기로 화면을 전환하며, 각 화면은 5초씩 표시
- 화면 전환 시에만 LCD를 초기화하여 깜빡임 최소화

## 5. 전체 시스템 동작

- 1초마다 모든 가스 농도를 측정
- 측정된 값을 두 개의 화면으로 나누어 표시
- non-blocking 방식으로 구현하여 시스템의 반응성 유지
- 에러 처리(무한대 값, 0값 감지)를 통한 안정성 확보

## 6. 마무리

이 시스템은 실내 공기질 모니터링에 활용할 수 있으며, 측정된 데이터를 보기 쉽게 표시합니다. 특히 CO2 농도 모니터링을 통해 실내 환기 시점을 결정하는 데 도움이 될 수 있습니다. 추가로 데이터 로깅이나 경보 시스템을 구현하면 더욱 유용한 시스템으로 발전시킬 수 있을 것입니다.