# 목표

pms7003 패시브 모드를 활용함에 있어서 아두이노 시리얼 통신을 이용해서 제어하는 시스템을 만드는게 목적임

1. 각 미세먼지 단위별로 ( 총 3가지 ) 시리얼 명령을 해서 값을 출력 해주는 시스템 및 이전 값과 +-까지 비교 해주는 시스템을 만든다.

1-1. 1에 의해서 총 3가지 메뉴가 우선 생긴다. 

2. 3가지 미세먼지 단위를 모두 표시 하는 시리얼 명령을 통해서 종합 값을 확인 할 수 있도록 한다.

3. 모든 값들은 표 형태로 나올 수 있게 한다.

4. 내부 미세먼지 단위별 값들은 비교를 위해서 저장을 해두어야 한다. 2초간격으로 5분간의 데이터를 저장한다.

5. 마지막으로 5분가의 데이터를 분석해서 증감이 어떤지 결론 내주는 시스템을 마지막으로 마무리 하고 

6. 모든 미세먼지 저장된 값을 리셋하고 다시 시작하는 시스템을 만든다.

---

## 설계 개요

- **플랫폼**: Arduino Uno (5 V) / Mega (필요 시) – `SoftwareSerial` 사용
- **시리얼 인터페이스**: `Serial` (PC와 통신) + `SoftwareSerial` (PMS7003) 
- **데이터 저장**: RAM 배열 (`uint16_t pmData[3][150]`)  
  - 3 개의 입자 크기(PM1.0, PM2.5, PM10) × 150 샘플 (5 분 / 2 초) 
- **명령 구조**: `GET <IDX>` (0‑2) → 개별값, `GET ALL` → 3값, `GET TABLE` → 표 출력, `ANALYZE` → 5분 변화 분석, `RESET` → 데이터 초기화

## 기능 명세

| 메뉴 | 설명 | 시리얼 명령 | 반환 형식 |
|------|------|------------|----------|
| 1 | PM1.0 값 조회 | `GET 0` | `PM1.0: <value> µg/m³` |
| 2 | PM2.5 값 조회 | `GET 1` | `PM2.5: <value> µg/m³` |
| 3 | PM10 값 조회 | `GET 2` | `PM10: <value> µg/m³` |
| 4 | 전체 값 조회 | `GET ALL` | `PM1.0:<v> PM2.5:<v> PM10:<v>` |
| 5 | 표 형태 출력 | `GET TABLE` | CSV‑like table (시간, PM1.0, PM2.5, PM10) |
| 6 | 5분 변화 분석 | `ANALYZE` | `↑`, `↓` 혹은 `=` 표시와 요약 메시지 |
| 7 | 데이터 초기화 | `RESET` | `DATA CLEARED` |

## 데이터 흐름
1. **초기화** – `setup()`에서 시리얼, `SoftwareSerial` 시작, 배열을 0 으로 초기화.
2. **패시브 모드 전환** – `pmsSerial.write(CMD_PASSIVE_MODE, …)`
3. **주기적 샘플링** – `loop()`에서 2 초마다 `requestData()` → `readPacket()` → 현재값 저장.
4. **명령 처리** – `Serial.available()` 로 들어온 문자열을 파싱하고 위 표에 맞는 함수를 호출.
5. **분석** – `ANALYZE` 시 5 분(150 샘플) 동안의 평균값을 계산하고 이전 평균과 비교.
6. **리셋** – `RESET` 시 배열을 모두 0 으로 재설정.

## 핵심 함수 (스케치 구조)
```cpp
void requestData();               // 센서에 READ_DATA 명령 전송
bool readPacket(uint8_t *buf);    // 패킷 수신·검증
void storeSample(uint16_t pm1, uint16_t pm25, uint16_t pm10);
void handleCommand(const String &cmd);
void printTable();                // 저장된 5분 데이터를 표 형태로 출력
void analyzeTrend();              // 평균·증감 판단
void resetData();                 // 배열 초기화
```

## 구현 단계 (시작 가이드)
1. **기본 스케치 복제** – 기존 `rev01.ino` 를 복사하고 `passiveMode` 를 `Passive Mode` 로 유지.
2. **배열 선언** – 전역에 `uint16_t pmHistory[3][150] = {0};` 와 `uint16_t sampleIdx = 0;` 추가.
3. **샘플 저장 로직** – `storeSample()` 에서 `pmHistory[0][sampleIdx] = pm1; …` 후 `sampleIdx = (sampleIdx + 1) % 150;`.
4. **시리얼 명령 파서** – `String cmd = Serial.readStringUntil('\n'); handleCommand(cmd.trim());`
5. **각 명령 구현** – `GET`, `GET ALL`, `GET TABLE`, `ANALYZE`, `RESET`.
6. **표 출력** – `Serial.println(F("Idx,PM1.0,PM2.5,PM10"));` 루프 돌며 `Serial.print(i); …`.
7. **분석 로직** – 150 샘플 평균을 구하고 이전 150 샘플 평균(저장된 두 번째 순환)과 비교.
8. **테스트** – 시리얼 모니터에서 각 명령을 입력하고 출력이 예상대로인지 확인.

## 테스트 시나리오
| 단계 | 입력 | 기대 출력 |
|------|------|-----------|
| 1 | (자동 샘플링 10 초) | 콘솔에 `Waiting for valid data...` 혹은 최신 PM 값이 출력되지 않음 (정상) |
| 2 | `GET 1` | `PM2.5: <숫자> µg/m³` |
| 3 | `GET ALL` | `PM1.0:<v> PM2.5:<v> PM10:<v>` |
| 4 | 5 분(150 샘플) 후 `GET TABLE` | 150 행의 CSV‑like 표가 출력됨 |
| 5 | `ANALYZE` | `PM2.5 ↑ 12%` 와 같은 증감 요약 |
| 6 | `RESET` | `DATA CLEARED` 와 함께 배열이 0 으로 초기화됨 |

## 남은 질문 (답변 필요)
1. **보드 선택** – Uno 로 충분한가요? 혹은 Mega/ESP32 등 다른 보드를 원하시나요?
2. **출력 방식** – 표를 단순 CSV 로 출력하거나, `Serial.println()` 로 라인별 출력 중 어느 쪽을 선호하시나요?
3. **데이터 보관** – RAM 외에 SD 카드 등 영구 저장이 필요합니까?
4. **시리얼 속도** – 현재 `115200` 사용 중인데, 다른 속도가 필요합니까?
5. **추가 기능** – 예를 들어 알람(임계치 초과)이나 LED 표시 등을 원하시나요?

> 위 질문에 답변 주시면 최종 스케치를 완성하고, 필요 시 별도 `README.md` 를 생성해 드리겠습니다.
```
