# Nextion 그래프 그리기 중 입력 지연 개선 로직 제안

## 문제 요약
- 그래프를 그리는 for 루프가 길게 실행되면, 그 동안 터치 이벤트 처리 루프가 지연됨.
- 결과적으로 버튼 입력이 즉시 반응하지 못하고, 일정 시간 후에 처리됨.

## 목표
- 터치 이벤트를 우선적으로 처리한다.
- 그래프 그리기는 분할/지연 없이 계속 진행되되, 짧은 단위로 쪼개서 실행한다.
- Nextion으로 보내는 명령을 큐로 관리해 우선순위를 줄 수 있도록 한다.

## 추천 로직: 이벤트 큐 기반 처리

### 핵심 아이디어
1. **터치 이벤트를 먼저 처리**하고, 그래프 그리기는 그 다음에 처리한다.
2. 그래프 그리기 명령을 즉시 전송하지 않고 **송신 큐에 적재**한다.
3. 루프마다 **큐에서 일정량만 전송**하여 길게 블로킹되는 일을 막는다.
4. 터치 이벤트는 **즉시 처리 큐**로 분리하여 우선적으로 처리한다.

### 처리 흐름 (개념)
- loop()
  - processNextionInput()에서 터치 이벤트 수신
  - 터치 이벤트는 즉시 처리 (또는 high-priority 큐로 분리)
  - updateWaveformData()는 그래프 명령을 생성만 하고 송신은 하지 않음
  - sendQueuedCommands()에서 매 루프마다 제한된 개수만 전송

### 큐 설계
- 두 개의 큐 또는 우선순위 큐 사용
  - High: 터치에 반응하는 화면 갱신 명령
  - Low: 그래프 add, xfloat 업데이트 등 연속 데이터
- 매 loop에서 High 큐를 먼저 소진하고, 남는 시간에 Low 큐를 전송

### 장점
- 긴 for 루프를 분할하여 **입력 지연 최소화**
- 그래프 송신량이 많아도 **터치 응답 유지**
- UI 이벤트 우선 처리 보장

## 구현 전략 (현 코드 기준)

### 1) 그래프 명령 생성과 전송 분리
- `sendWaveformPoint()`를 즉시 전송하지 않고, `enqueueWaveformPoint()`로 변경
- 실제 전송은 `flushTxQueue(maxBytesPerLoop)` 같은 함수에서 처리

### 2) 한 루프에 전송량 제한
- 예: 한 번에 5~20개의 add 명령만 전송
- 다음 loop에서 계속 전송
- 이렇게 하면 draw 과정이 짧게 쪼개짐

### 3) 터치 이벤트 우선 처리
- 터치 이벤트가 들어오면, 그래프 명령 전송보다 우선 실행
- 필요 시 그래프 송신은 잠시 중단 (suspend flag)

## 대안 로직 (상황에 따라 조합)

### A) 타임슬라이스 기반 (시간 제한)
- 한 loop에서 그래프 처리 시간을 예: 2~3ms로 제한
- 시간 초과 시 즉시 반환하고 다음 loop에서 이어서 처리

### B) 라인 스텝 동적 감소
- 입력이 많을 때 `LINE_STEPS`를 줄여 그래프 점 수를 감소
- 사용자 입력이 없는 경우 다시 복원

### C) 일정 주기로만 그래프 업데이트
- 터치 이벤트가 자주 발생할 때 `UPDATE_INTERVAL`을 일시적으로 늘림

## 기대 효과
- 버튼 클릭 즉시 반응
- 그래프는 약간 늦더라도 끊김 없이 계속 표현
- 전체 UX 개선

## 다음 단계 제안
1. 명령 큐 자료구조 설계 (고정 배열 기반 ring queue 추천)
2. 그래프 add/xfloat을 큐 전송 방식으로 변경
3. High/Low 큐 우선순위 로직 추가
4. 실제 하드웨어에서 응답 지연 측정
