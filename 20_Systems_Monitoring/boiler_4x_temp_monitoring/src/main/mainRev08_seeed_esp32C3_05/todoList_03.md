# TODO 03 — 통합 모니터링 분석 도구 (Python + HTML5 + Batch)

설명:
- 데이터 수집(Python)과 시각화 분석(HTML)을 하나의 통합 도구로 결합하여 운영 편의성을 극대화함.
- **통합 방식**: Python이 데이터 수집(Backend)과 웹 서버(Frontend Serving) 역할을 동시에 수행하며, 배치 파일(.bat) 하나로 전 부팅 프로세스를 자동화함.

요구 사항:
1. **Python 통합 서버**: 
   - 2초 간격 고빈도 데이터 수집 및 로컬 파일(`docs/logs`) 저장.
   - Flask 또는 내장 `http.server`를 활용하여 분석용 HTML 페이지 서빙.
   - 최근 6시간 데이터를 즉시 추출하여 HTML에 전달하는 정적/동적 API 제공.
2. **분석 UI (HTML/JS)**:
   - 최신 데이터 기준 6시간 가변 범위 대응 (기록 부족 시 Gray-out 처리).
   - [추가 제안] 임계치 선(80도), 온도 변화율 시각화, Zoom/Pan 인터랙티브 차트 적용.
   - 실시간 업데이트(Polling)와 과거 로그 조회의 자연스러운 결합.
3. **자동화**: 
   - 원클릭 실행용 배치 파일(`run_analyzer.bat`) 제작 (Python 가상환경 및 브라우저 자동 호출).

[수행 항목]:
- [x] Python 통합 서버 스크립트 설계 및 웹 서버 기능 추가 (`tools/analyzer_integrated/analyzer_server.py`)
- [x] 6시간 범위 대응용 JavaScript 차트 로직 구현 (`tools/analyzer_integrated/analyzer_ui.html`)
- [x] `run_analyzer.bat` 배치 파일 생성 및 환경 테스트.

검증(테스트 케이스):
- [x] 배치 파일 클릭 시 "데이터 수집 시작 -> 웹 서버 기동 -> 브라우저 자동 실행" 확인.
- [x] 브라우저를 껐다 켜도 수집 중이던 지난 6시간 데이터가 즉시 차트에 로드되는지 확인.

상태:
- 담당자: GitHub Copilot
- 시작일: 2026-02-05
- 완료일: 2026-02-06
- 진행상태: completed

### 구현 상세 (Integrated Analyzer v2.0)

1. **통합 분석기 (analyzer_server.py)**
   - **이중 라이브러리 지원**: `requests` 라이브러리를 기본 사용하되, 미설치 시 표준 라이브러리 `urllib`로 자동 폴백(Fallback).
   - **타임스탬프 동적 주입**: 기존 로그 파일에 `ts` 필드가 없더라도 서버가 파일을 읽을 때 파일명(`YYYY-MM-DD_HH-MM-SS.json`)에서 시간을 추출하여 클라이언트에 전달.
   - **분석 모드 자동 전환**: 7회 연속 접속 실패 시 `ANALYSIS` 모드로 자동 전환하여 아두이노 부하를 줄이고 기존 데이터를 열람하도록 유도.
   - **로그 관리**: 14일 경과 로그 폴더 자동 삭제(`shutil.rmtree`) 기능 내장.

2. **프론트엔드 UI (analyzer_ui.html)**
   - **히스토리 브라우저**: 서버의 `/api/dates`를 호출하여 실제 로그가 존재하는 날짜만 드롭다운에 표시.
   - **차트 최적화**: Chart.js의 `time` axis를 완벽 정합하여 실시간 데이터와 과거 데이터를 동일한 타임라인 상에 표시.
   - **오버레이 가이드**: 현재 보고 있는 데이터 상태와 레코드 개수를 시각화 (배경 반투명 처리로 레전드 겹침 방지).
   - **상/하한 점선 (Thresholds)**: Upper(빨강)/Lower(초록) 2개 라인을 각각 독립 설정. 세로 배치 UI.
   - **크로스헤어 + 툴팁**: 마우스 위치에 수직선 표시 및 4채널 센서값 + ΔT(S1-S2, S3-S4) 차이값 동시 표시.
   - **뷰 버튼 활성 상태**: 6시간/1시간 버튼 클릭 시 활성 버튼 색상 반전(`.active`).
   - **Y축 자동 스케일링**: 데이터 범위에 밀착하여 `grace: 10%`로 자동 줌. 고정 0~100 범위 제거.
   - **반응형 레이아웃**: 세로 모니터(1080×1920) 대응. 뷰포트 1200px 이하에서 레전드/폰트/패딩 자동 축소.
   - **Smart X축 줌**: 수집 시작 직후 데이터가 적을 때 6시간 전체를 비우지 않고 데이터 범위에 밀착 표시.

3. **실행 환경 (run_analyzer.bat)**
   - **포트 충돌 방지**: 8080 포트를 점유 중인 기존 Python 프로세스를 강제 종료(`taskkill`) 후 서버 실행.
   - **경로 자동화**: 루트 디렉토리에서 배치 파일 하나로 서버 실행 + 브라우저 자동 오픈.

첨부(로그/스크린샷):
- 실시간 수집 + 크로스헤어 툴팁 + 상/하한 점선 동작 확인 (2026-02-06 22:30경)

메모:
- v2.0: 서버 근본 수정 (IP, ts 주입, requests 전환)
- v2.1: UI 완성 (크로스헤어, ΔT 툴팁, 상/하한 이중 점선, 반응형 레이아웃, 뷰 버튼 상태 반전)
