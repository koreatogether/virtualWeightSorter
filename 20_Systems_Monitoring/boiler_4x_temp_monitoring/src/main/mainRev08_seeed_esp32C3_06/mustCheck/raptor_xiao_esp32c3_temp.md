# Raptor: XIAO ESP32-C3 — Rev02 상태 평가 및 Rev03 준비 계획

## 요약 ✅
본 문서는 `mainRev08_seeed_esp32C3_02`(이하 Rev02)의 전체 프로세스를 평가하고, 실사용(필드) 단계에서 발견될 수 있는 버그·통합 이슈를 정리하여 `mainRev08_seeed_esp32C3_03`(이하 Rev03)으로의 안정적 전환을 위한 권고사항과 우선순위 목록을 제공합니다.

---

## 핵심 성과 (Rev02) ✨
- ESP32-C3로 마이그레이션 성공: WiFi/NTP/mDNS, 웹서버(JSON API/대시보드), DS18B20 센서 수집 기능 구현 완료. (`WiFiManager.cpp`, `SensorManager.cpp`, `main.cpp`)
- Nextion 통신을 라이브러리 의존 없이 **직접 시리얼 제어**로 안정화(9600→115200 전환 로직 포함). (`NextionManager.*`) 
- 빌드 환경 격리 및 platformio 설정 고정으로 컴파일 재현성 확보(`platformio.ini` 설정 반영). 
- 로그/툴(데이터 수집기, 로그 플레이어) 구축으로 실기 검증 준비 완료(`tools/data_collector`, `tools/log_player`).

---

## Rev02 전체 프로세스 흐름 요약 🧭
1. **부팅/초기화 단계**
   - `setup()`에서 Nextion → 센서 → 초기 표시 → WiFi 순으로 초기화.
   - 초기 데이터(온도/표시)를 WiFi 연결 전에 먼저 전송하여 UI 선출력 보장.

2. **주기 루프 단계**
   - `loop()`에서 WiFi 핸들러 → Nextion 입력 처리 → 주기적 센서 읽기/표시.
   - 샘플 주기는 `SAMPLE_INTERVAL_MS(2000ms)` 기준.

3. **디스플레이 업데이트(Nextion)**
   - 텍스트/파형/Waveform 동기화 및 터치 이벤트 처리.
   - 9600bps 핸드셰이크 후 115200bps로 영구 전환.

4. **네트워크/웹 대시보드**
   - 고정 IP 구성 후 WiFi 연결, mDNS 등록(`boiler.local`), HTTP 서버 기동.
   - `/data` JSON API + 간단 로그인 페이지(쿠키 기반) 제공.

---

## 구현 상세 평가 (코드 기반) 🧩
- **부팅 시퀀스**: Nextion → Sensors → UI 갱신 → WiFi 순서가 실사용에서 안정적 (디스플레이 상태 확인 가능). (`main.cpp`)
- **온도 수집**: DS18B20 주소를 부팅 시 스캔하여 순서 고정, 이후 반복 읽기. (`SensorManager.cpp`)
- **UI 갱신**: 텍스트/차트 갱신과 터치 입력 처리 분리, 파형 버퍼로 채널 동기화 처리. (`NextionManager.cpp`)
- **네트워크**: 고정 IP + NTP + mDNS + WebServer 조합으로 실시간 대시보드 구성. (`WiFiManager.cpp`, `Dashboard.h`)

---

## 발견된 리스크·버그(우선순위 별) ⚠️
1. 전원 공급/전류 관련 위험 — **중요**
   - 5V/3.3V 전원 레일과 USB VBUS 한계(레귤레이터/포트별 차이)를 README에 반영하였으나, 실제 케이스 조립시 주변기기(Nextion, 센서, 레벨 시프터) 전류 합계 검증 필요.
   - 조치: 실하드웨어 전류 소비(부하별) 측정 및 전원 예비 설계(외부 전원 권장).

2. Nextion 통신 안정성(속도 전환/재시작 경로) — **중요**
   - 9600→115200 자동 전환 로직이 구현되어 있고 EEPROM 변경을 인지함. 그러나 전원 재시작/비정상 재연결 시 복구 시나리오(타임아웃, 재시도 횟수 등) 추가 필요.
   - 조치: 핸드셰이크 실패 시 재시도·재설정 로직 및 상태 표시(로그/화면) 추가.

3. WiFi 재연결 및 서비스 복구 — **중요**
   - 현재 WiFi 연결 실패 시 재시도/복구 루틴이 부족하며, mDNS/서버 재기동 트리거가 없음.
   - 조치: 연결 감시(링크 다운 시 재연결) + mDNS/서버 재시작 경로 추가.

4. 라이브러리 충돌 및 환경 의존성 — **중간**
   - 로컬 Arduino 라이브러리(AVR 기반) 충돌 문제를 `lib_ignore`로 해결했으나, CI/다른 개발자 환경에서 동일 문제 재발 가능.
   - 조치: 프로젝트 문서화(설정 가이드)와 간단한 CI 빌드(PlatformIO CLI) 추가.

5. 웹 인증/보안 최소화 — **중간**
   - 대시보드 비밀번호가 고정 문자열이며 쿠키는 보안 속성이 없음.
   - 조치: 비밀번호 외부 설정, 세션 만료/랜덤 토큰, 내부망 전용 사용 가이드 추가.

6. 동시 센서/IO 부하 및 3.3V 레일 안정성 — **중간**
   - 여러 GPIO에서 연속적으로 전류 요구 시 레일 전압 강하 및 리셋 위험.
   - 조치: 전류 스트레스 테스트 및 전압 모니터링 추가.

7. 비정상적인 메모리·스택/동시성 이슈 — **낮음/모니터링 필요**
   - 장시간 동작(메모리 누수, 비동기 처리에서 블로킹)이 필드에서 발생할 수 있음.
   - 조치: watchdog, 메모리/힙 로그, 장시간 동작 검증 케이스 작성.

---

## 코드 기준 추가 관찰 🔍
- `/data` API는 센서 수 개수가 4개 미만이어도 4개 값을 전송하므로, `DEVICE_DISCONNECTED_C`에 대한 UI 처리 필요.
- `updateNextionDisplay()`의 `delay(SEND_DELAY_MS)`는 채널 수/라인 스텝 증가 시 루프 지연을 유발할 수 있음.
- `initWiFi()` 실패 시, 웹 서버 미기동 상태로 유지되므로 현장 디버깅 정보(LED/Serial) 보강이 효과적.

---

## 통합/검증 계획 (테스트 항목) 🧪
1. 하드웨어-in-the-loop(HIL) 테스트
   - Nextion 연결(터치 이벤트 포함) 장시간(48~72시간) 가동 테스트.
   - 9600/115200 전환 반복 테스트(전원 사이클 포함).

2. 전원·온도·전류 스트레스 테스트
   - 전체 시스템(디스플레이, 센서, WiFi 등) 동시 부하 시 전류 측정 및 3.3V/5V 레일 온도 관찰.

3. 통신·복구 테스트
   - WiFi 끊김·재연결, NTP 실패, mDNS 재발행, 웹 API 동시 요청에 대한 복구 검증.

4. 통합 테스팅(데이터 파이프라인)
   - `data_collector`와의 연동, 로그 포맷 일관성, 타임스탬프 동기화 확인.

5. 자동 빌드 & 정적 분석
   - PlatformIO CLI 기반 CI: 빌드+단순 테스트(컴파일, lint), 의존성 체크 수행.

---

## 권고 작업 목록(우선순위) 🔧
1 (즉시): 전원/전류 안전성 검증 및 README/문서 업데이트. ✅
2 (단기): Nextion 통신 복구 로직(타임아웃/재시도) 및 상태 LED/로그 개선. ✅
3 (단기): CI 파이프라인 추가(빌드 재현, lib_ignore 검증). 
4 (중기): 장시간 HIL 테스트(48~72h) 및 스트레스 테스트 자동화 스크립트 작성. 
5 (중기): 텔레메트리(온도/전압/메모리) 도입 — OTA 업그레이드 대비 모니터링 로그 수집. 
6 (향후): 정식 리비전(Rev03) 태그 및 CHANGELOG 작성, 배포 전 알파/베타 필드 테스트 계획 수립.

---

## Release 체크리스트 (Rev03 진입 전) 📋
- [ ] 전원/전류 테스트 결과 문서화 (테스트 벤치 리포트 첨부)
- [ ] Nextion 복구 시나리오·테스트 케이스 통과
- [ ] CI 빌드 통과 (Windows/Ubuntu 기본 스크립트)
- [ ] 코드리뷰 및 ADR(핵심 설계 결정) 문서화
- [ ] progressLog에 테스트 로그(핵심 실패/복구 사례) 업로드
- [ ] README 및 MIGRATION_PRECHECK 업데이트

---

## 권장 일정(제안) ⏱️
- 0–3일: 전원·전류 스트레스 테스트 + README 보강
- 3–10일: Nextion 복구 로직 구현 및 HIL(48h) 테스트 시작
- 10–21일: CI 구축, 장기 동작 테스트, 버그 패치
- 21–30일: Rev03 릴리스 후보(Release Candidate) 및 소규모 필드 배포

---

## 참고(위치) 📂
- 주요 코드: `src/main/mainRev08_seeed_esp32C3_02/` (`main.cpp`, `NextionManager.*`, `SensorManager.*`, `WiFiManager.*`)
- 진행 로그: `progressLog.md`
- 데이터 수집/도구: `tools/data_collector/`, `tools/log_player/`

---

## 결론 🎯
Rev02는 핵심 기능을 성공적으로 마이그레이션하고 실기 검증 준비까지 잘 갖춘 상태입니다. 다만 실사용 안정화를 위해 전원/통신 복구 경로와 장기 동작 검증이 필요합니다. Rev03에서는 위 우선순위(전원 → 통신 복구 → CI → 장기 테스트)를 따라 안정화에 집중하면 좋겠습니다.

---

*작성자: Raptor (자동평가 보조) — 생성일: 2026-02-06*
